{
  "hash": "126f20fa3fa1eb68c8082e58543ebeab",
  "result": {
    "markdown": "---\n# Documentation: https://sourcethemes.com/academic/docs/managing-content/\n\ntitle: \"Driving Alone vs. Public Transportation in Pittsburgh\"\nsubtitle: \"Mapping commuter modes with bivariate discretized bins\"\nsummary: \"\"\nauthors: [Conor Tompkins]\ntags: []\ncategories: []\ndate: 2021-03-29\nlastmod: 2021-03-29\nfeatured: false\ndraft: false\nprojects: []\nexecute:\n  echo: true\n  warning: false\n  message: false\nimage: combined_bi_var_transit_featured.png\n---\n\n::: {.cell}\n::: {.cell-output-display}\n![](combined_bi_var_transit_featured.png){width=3000}\n:::\n:::\n\n\n### Intro\n\nThe clash between public transportation and single passenger vehicles is a heated topic of discussion [nationally](https://www.nytimes.com/2020/07/09/opinion/sunday/ban-cars-manhattan-cities.html) and in the [Pittsburgh area](https://www.pghcitypaper.com/pittsburgh/pittsburgh-is-the-7th-least-car-dependent-metro-in-america-study-says/Content?oid=16755873). [Public transit ridership has been heavily reduced by COVID-19](https://www.nytimes.com/2021/03/25/climate/buses-trains-ridership-climate-change.html) in many countries. These two commuting modes compete for the same riders, and investment dollars, and space. Car drivers are frustrated when a bus stops during rush hour to pick up passengers, while bus passengers are frustrated sitting in traffic caused by single passenger vehicles because transit doesn't have right-of-way.\n\nFrom my point of view, Pittsburgh's geography lends itself to a focus on public transit, at the expense of the single passenger vehicle. Most of the jobs in the county are in a single census tract Downtown, which is reflected in the spoke (and no wheel) design of the transit system. Downtown is surrounded by rivers and mountains, which drastically narrows the geography suited to infrastructure. You pretty much have to use a tunnel or bridge to commute Downtown, unless you are coming from directly east. It would make sense to give public transit priority access to those tunnels and bridges, since their throughput is [many times higher](https://nacto.org/publication/transit-street-design-guide/introduction/why/designing-move-people/) than roads designated for single passenger vehicles.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](https://nacto.org/wp-content/uploads/2016/04/Design-to-Move-People_all-e1461361807936.jpg)\n:::\n:::\n\n\nThe historical priority towards single passenger vehicles is reflected in the Census statistics about commuting modes in the area. Most people in the area commute to work by themselves in cars. In the Wexford-area census tract, 78% (5,141) of commuters drive to work alone (and sit in traffic on the parkway together). Public transit use is limited to areas where the government invested in transit, but even there transit is not typically the majority mode.\n\nIn this post I will use `{tidycensus}` to pull data about how many people commute by driving alone or taking public transit Allegheny County. I chose these two modes because they are the two most popular modes in the county, and are the most different in terms of style. I then graph the data with `{ggplot2}` and `{biscale}`. I hack the `{biscale}` legend a bit to get it to show the % of commuters, which may be of interest to other R users.\n\n### Code and graphs\n\nLoad libraries and set up the environment:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidycensus)\nlibrary(sf)\nlibrary(tigris)\nlibrary(janitor)\nlibrary(biscale)\nlibrary(patchwork)\nlibrary(hrbrthemes)\nlibrary(kableExtra)\n\noptions(scipen = 999, digits = 4)\n\ntheme_set(theme_ipsum(base_size = 25))\n```\n:::\n\n\nThese are the variables about commuter mode that the Census has for the 2019 American Community Survey (ACS):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nacs1_vars <- load_variables(2019, 'acs1') %>% \n  mutate(across(c(label, concept), str_to_lower))\n\nacs1_vars %>%\n  filter(str_detect(name, \"^B08301_\")) %>% \n  kbl() %>% \n  scroll_box(height = \"400px\") %>% \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\", \"responsive\"),\n                position = \"left\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div style=\"border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:400px;  \" class=\"table table-striped table-hover table-condensed table-responsive\"><table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;position: sticky; top:0; background-color: #FFFFFF;\"> name </th>\n   <th style=\"text-align:left;position: sticky; top:0; background-color: #FFFFFF;\"> label </th>\n   <th style=\"text-align:left;position: sticky; top:0; background-color: #FFFFFF;\"> concept </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_001 </td>\n   <td style=\"text-align:left;\"> estimate!!total: </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_002 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!car, truck, or van: </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_003 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!car, truck, or van:!!drove alone </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_004 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!car, truck, or van:!!carpooled: </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_005 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!car, truck, or van:!!carpooled:!!in 2-person carpool </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_006 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!car, truck, or van:!!carpooled:!!in 3-person carpool </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_007 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!car, truck, or van:!!carpooled:!!in 4-person carpool </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_008 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!car, truck, or van:!!carpooled:!!in 5- or 6-person carpool </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_009 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!car, truck, or van:!!carpooled:!!in 7-or-more-person carpool </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_010 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!public transportation (excluding taxicab): </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_011 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!public transportation (excluding taxicab):!!bus </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_012 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!public transportation (excluding taxicab):!!subway or elevated rail </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_013 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!public transportation (excluding taxicab):!!long-distance train or commuter rail </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_014 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!public transportation (excluding taxicab):!!light rail, streetcar or trolley (carro p√∫blico in puerto rico) </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_015 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!public transportation (excluding taxicab):!!ferryboat </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_016 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!taxicab </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_017 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!motorcycle </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_018 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!bicycle </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_019 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!walked </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_020 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!other means </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> B08301_021 </td>\n   <td style=\"text-align:left;\"> estimate!!total:!!worked from home </td>\n   <td style=\"text-align:left;\"> means of transportation to work </td>\n  </tr>\n</tbody>\n</table></div>\n\n`````\n:::\n:::\n\n\nDriving alone in a single-passenger vehicle is by far the dominant commuting mode in the county.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_transit_vars <- c(\"B08301_003\", \n                      \"B08301_004\", \n                      \"B08301_010\", \n                      \"B08301_016\", \n                      \"B08301_017\", \n                      \"B08301_018\", \n                      \"B08301_019\", \n                      \"B08301_020\",\n                      \"B08301_021\")\n\nall_transit_modes <- get_acs(geography = \"county\", \n                             variables = acs1_vars %>%\n                               filter(name %in% all_transit_vars) %>% \n                               pull(name, label),\n                             summary_var = \"B08301_001\",\n                             year = 2019, state = \"PA\", county = \"Allegheny\",\n                             geometry = F)\n\nall_transit_modes %>% \n  mutate(variable = str_remove(variable, \"^estimate!!total:\"),\n         variable = str_remove(variable, \"\\\\(excluding taxicab\\\\)\"),\n         variable = str_remove_all(variable, \"\\\\!\"),\n         variable = str_remove(variable, \":$\"),\n         variable = str_replace(variable, \":\", \" : \"),\n         variable = str_trim(variable),\n         variable = str_to_title(variable)) %>% \n  group_by(variable) %>% \n  summarize(estimate = sum(estimate),) %>% \n  mutate(variable = fct_reorder(variable, estimate),\n         pct = estimate / sum(estimate)) %>% \n  ggplot(aes(estimate, variable)) +\n  geom_col() +\n  geom_text(aes(x = estimate + 26000, label = scales::percent(pct, 1)),\n            size = 4) +\n  labs(title = \"Allegheny County Commuter Modes\",\n       subtitle = \"2019 American Community Survey\",\n       x = \"Commuters\",\n       y = NULL) +\n  scale_x_comma(limits = c(0, 500000),\n                labels = c(\"0\", \"1k\", \"2k\", \"3k\", \"4k\", \"5k\")) +\n  theme_ipsum(axis_text_size = 15)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nI will use these two variables to directly compare the use of single-passenger vehicles and public transit in the county.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvars <- c(\"Drove alone\" = \"B08301_003\",\n          \"Public transportation\" = \"B08301_010\")\n\nacs1_vars %>%\n  filter(name %in% vars) %>% \n  pull(label)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"estimate!!total:!!car, truck, or van:!!drove alone\"          \n[2] \"estimate!!total:!!public transportation (excluding taxicab):\"\n```\n:::\n:::\n\n\nThis downloads the commuter mode data and subtracts the rivers from the census tract polygons so it looks nice on a map:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntract_transit %>% \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 804\nColumns: 5\n$ GEOID       <chr> \"42003408002\", \"42003408002\", \"42003210700\", \"42003210700\"‚Ä¶\n$ variable    <chr> \"Drove alone\", \"Public transportation\", \"Drove alone\", \"Pu‚Ä¶\n$ estimate    <dbl> 2815, 8, 589, 189, 566, 146, 1224, 260, 466, 100, 1063, 21‚Ä¶\n$ summary_est <dbl> 3165, 3165, 1231, 1231, 1110, 1110, 1992, 1992, 702, 702, ‚Ä¶\n$ geometry    <POLYGON [¬∞]> POLYGON ((-79.99 40.61, -79..., POLYGON ((-79.99 4‚Ä¶\n```\n:::\n:::\n\n\nAs discussed earlier, public transit is not the majority commuting mode in most areas:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntract_transit %>% \n  st_drop_geometry() %>% \n  group_by(GEOID) %>%\n  mutate(pct_tract_commuters = estimate / sum(estimate),\n         combined_commuters = sum(estimate)) %>%\n  ungroup() %>%\n  mutate(GEOID = fct_reorder(GEOID, summary_est)) %>%\n  arrange(desc(GEOID), desc(summary_est)) %>% \n  mutate(is_downtown_label = case_when(GEOID == \"42003020100\" & variable == \"Drove alone\" ~ \"Downtown*\",\n                                       TRUE ~ NA_character_)) %>% \n  slice(1:60) %>% \n  ggplot(aes(estimate, GEOID, fill = variable)) +\n  geom_col(color = \"black\") +\n  geom_text(aes(x = estimate + 3000, label = is_downtown_label)) +\n  labs(title = \"Top 30 census tracts\",\n       subtitle = \"Total commuter population from all modes\",\n       x = \"Commuters\",\n       y = \"Census tracts\",\n       fill = \"Commute mode\") +\n  scale_x_comma() +\n  theme_ipsum(base_size = 15) +\n  theme(axis.text.y = element_blank(),\n        panel.grid.major = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\\*Most commuters that live in Downtown walk to work.\n\nThis shows that in absolute numbers, driving alone swamps public transit across the county.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nscatter_graph <- tract_transit %>% \n  st_drop_geometry() %>% \n  select(GEOID, variable, estimate) %>% \n  pivot_wider(names_from = variable, values_from = estimate) %>% \n  clean_names() %>% \n  ggplot(aes(drove_alone, public_transportation)) +\n  geom_point(alpha = .7, size = 1) +\n  labs(title = \"Commuter modes in Allegheny County\",\n       x = \"Driving Alone\",\n       y = \"Using Public Transportation\") +\n  scale_x_comma() +\n  scale_y_comma() +\n  tune::coord_obs_pred() +\n  theme_ipsum(base_size = 15)\n\nscatter_graph\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nI made the X and Y axes symmetric to emphasize the difference in scale between the two variables.\n\nThis uses the `bi_class` function to divide the data into discrete bins based on how many people drive alone vs. use public transit. This turns two continuous variables into one categorical variable. I had to play around with the `style` argument to find an option that worked for the unbalanced data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntransit_bivariate_geo <- tract_transit %>% \n  st_drop_geometry() %>% \n  drop_na(estimate) %>% \n  select(GEOID, variable, estimate) %>% \n  pivot_wider(names_from = variable, values_from = estimate) %>% \n  clean_names() %>% \n  replace_na(list(drove_alone = 0, public_transportation = 0)) %>% \n  bi_class(x = drove_alone, \n           y = public_transportation, \n           style = \"fisher\", \n           dim = 3) %>% \n  left_join(tracts, \n            by = c(\"geoid\" = \"GEOID\")) %>% \n  st_sf()\n\nglimpse(transit_bivariate_geo)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 402\nColumns: 9\n$ geoid                 <chr> \"42003408002\", \"42003210700\", \"42003220600\", \"42‚Ä¶\n$ drove_alone           <dbl> 2815, 589, 566, 1224, 466, 1063, 887, 826, 551, ‚Ä¶\n$ public_transportation <dbl> 8, 189, 146, 260, 100, 215, 262, 342, 670, 61, 3‚Ä¶\n$ bi_class              <chr> \"3-1\", \"1-2\", \"1-1\", \"2-2\", \"1-1\", \"2-2\", \"1-2\",‚Ä¶\n$ NAME                  <chr> \"Census Tract 4080.02, Allegheny County, Pennsyl‚Ä¶\n$ variable              <chr> \"B08301_001\", \"B08301_001\", \"B08301_001\", \"B0830‚Ä¶\n$ estimate              <dbl> 3165, 1231, 1110, 1992, 702, 1487, 1317, 1712, 1‚Ä¶\n$ moe                   <dbl> 231, 199, 116, 189, 80, 233, 163, 185, 257, 104,‚Ä¶\n$ geometry              <POLYGON [¬∞]> POLYGON ((-79.99 40.61, -79..., POLYGON ‚Ä¶\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(transit_bivariate_geo$bi_class) %>% \n  enframe(name = \"bi_class\", value = \"count_tracts\") %>% \n  kbl()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> bi_class </th>\n   <th style=\"text-align:right;\"> count_tracts </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 1-1 </td>\n   <td style=\"text-align:right;\"> 124 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1-2 </td>\n   <td style=\"text-align:right;\"> 72 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1-3 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2-1 </td>\n   <td style=\"text-align:right;\"> 84 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2-2 </td>\n   <td style=\"text-align:right;\"> 66 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2-3 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3-1 </td>\n   <td style=\"text-align:right;\"> 34 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3-2 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThis graph overlays the discrete `biscale` bins on the previous data to show how the function discretized the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntransit_bivariate_geo %>% \n  ggplot(aes(drove_alone, public_transportation, color = bi_class)) +\n  geom_point(alpha = .75, size = 1) +\n  scale_x_comma() +\n  labs(x = \"Drove Alone\",\n       y = \"Used Public Transit\") +\n  guides(color = FALSE) +\n  theme_ipsum(base_size = 15)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\nNote that the X and Y axes are independent in this graph.\n\nThis creates the `biscale` legend I will put next to the map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbi_var_legend <- bi_legend(pal = \"DkBlue\",\n                           dim = 3,\n                           xlab = \" More drove alone\",\n                           ylab = \"More used public transit\",\n                           size = 26) +\n  theme(plot.background = element_rect(fill = alpha(\"white\", 0)),\n        panel.background = element_rect(fill = alpha(\"white\", 0)))\n\nbi_var_legend\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\nI would like to show the % of commuters that each bin represents, so I extract the color palette from the `ggplot2` object and make my own legend with `geom_tile.`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbuilt_legend <- ggplot_build(bi_var_legend)\n\nlegend_palette <- built_legend$data[[1]] %>%\n  mutate(bi_class = str_c(x, y, sep = \"-\")) %>% \n  select(fill, bi_class)\n\nlegend_palette %>% \n  kbl()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> fill </th>\n   <th style=\"text-align:left;\"> bi_class </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> #e8e8e8 </td>\n   <td style=\"text-align:left;\"> 1-1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> #ace4e4 </td>\n   <td style=\"text-align:left;\"> 2-1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> #5ac8c8 </td>\n   <td style=\"text-align:left;\"> 3-1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> #dfb0d6 </td>\n   <td style=\"text-align:left;\"> 1-2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> #a5add3 </td>\n   <td style=\"text-align:left;\"> 2-2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> #5698b9 </td>\n   <td style=\"text-align:left;\"> 3-2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> #be64ac </td>\n   <td style=\"text-align:left;\"> 1-3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> #8c62aa </td>\n   <td style=\"text-align:left;\"> 2-3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> #3b4994 </td>\n   <td style=\"text-align:left;\"> 3-3 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntransit_bivariate <- transit_bivariate_geo %>% \n  st_drop_geometry() %>% \n  select(geoid, bi_class, drove_alone, public_transportation) %>% \n  separate(bi_class, \n           into = c(\"drove_alone_bi\", \"public_transportation_bi\"), \n           sep = \"-\",\n           remove = FALSE) %>% \n  complete(drove_alone_bi, public_transportation_bi, fill = list(drove_alone = 0, public_transportation = 0)) %>% \n  mutate(bi_class = str_c(drove_alone_bi, public_transportation_bi, sep = \"-\"),\n         total = drove_alone + public_transportation,\n         pct_commuters = total / sum(total)) %>%\n  group_by(bi_class, drove_alone_bi, public_transportation_bi) %>% \n  summarize(count_tract = n(),\n            pct_commuters = sum(pct_commuters)) %>% \n  ungroup()\n\nglimpse(transit_bivariate)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 9\nColumns: 5\n$ bi_class                 <chr> \"1-1\", \"1-2\", \"1-3\", \"2-1\", \"2-2\", \"2-3\", \"3-‚Ä¶\n$ drove_alone_bi           <chr> \"1\", \"1\", \"1\", \"2\", \"2\", \"2\", \"3\", \"3\", \"3\"\n$ public_transportation_bi <chr> \"1\", \"2\", \"3\", \"1\", \"2\", \"3\", \"1\", \"2\", \"3\"\n$ count_tract              <int> 124, 72, 9, 84, 66, 9, 34, 4, 1\n$ pct_commuters            <dbl> 0.13661, 0.11754, 0.02073, 0.25273, 0.22252, ‚Ä¶\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlegend_palette <- transit_bivariate %>% \n  distinct(bi_class) %>% \n  left_join(legend_palette, by = \"bi_class\")\n\nlegend_palette %>% \n  kbl()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> bi_class </th>\n   <th style=\"text-align:left;\"> fill </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 1-1 </td>\n   <td style=\"text-align:left;\"> #e8e8e8 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1-2 </td>\n   <td style=\"text-align:left;\"> #dfb0d6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1-3 </td>\n   <td style=\"text-align:left;\"> #be64ac </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2-1 </td>\n   <td style=\"text-align:left;\"> #ace4e4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2-2 </td>\n   <td style=\"text-align:left;\"> #a5add3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2-3 </td>\n   <td style=\"text-align:left;\"> #8c62aa </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3-1 </td>\n   <td style=\"text-align:left;\"> #5ac8c8 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3-2 </td>\n   <td style=\"text-align:left;\"> #5698b9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3-3 </td>\n   <td style=\"text-align:left;\"> #3b4994 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nNote that `scale_fill_manual` uses the palette I extracted from the `ggplot2` object.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbi_var_legend_new <- transit_bivariate %>% \n  mutate(pct_commuters = scales::percent(pct_commuters, accuracy = 1)) %>% \n  ggplot(aes(x = drove_alone_bi, y = public_transportation_bi, fill = bi_class)) +\n  geom_tile() +\n  geom_label(fill = \"white\", alpha = .75, size = 12, label = \"    \") +\n  geom_text(aes(label = pct_commuters), alpha = 1, size = 7) +\n  coord_fixed(ratio = 1) +\n  labs(x = substitute(paste(\"More drove alone\", \"\" %->% \"\")),\n       y = substitute(paste(\"More used public transit\", \"\" %->% \"\"))) +\n  guides(fill = FALSE) +\n  scale_fill_manual(values = pull(legend_palette, fill)) +\n  theme_ipsum(plot_title_size = 30,\n              axis_title_size = 30) +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        panel.background = element_blank(),\n        axis.text.x = element_blank(),\n        axis.text.y = element_blank(),\n        axis.ticks = element_blank())\n\nbi_var_legend_new +\n  labs(title = 'Percent of \"drive alone\" + \"public transit\" commuters')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){width=1152}\n:::\n:::\n\n\nThis creates the map of commuter mode by census tract, filled by the discretized `biscale` bin.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntransit_bi_var_plot <- transit_bivariate_geo %>% \n  ggplot(aes(fill = bi_class)) +\n  geom_sf(show.legend = FALSE, lwd = 0) +\n  geom_sf(data = rivers, fill = \"black\", color = \"black\") +\n  bi_scale_fill(pal = \"DkBlue\", dim = 3) +\n  bi_theme() +\n  theme_ipsum(base_size = 15) +\n  theme(axis.text.x = element_blank(),\n        axis.text.y = element_blank(),\n        panel.background = element_blank(),\n        panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank())\n\ntransit_bi_var_plot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\nNow that I have my legend and map, I use `patchwork` to stitch them together.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndesign = c(area(t = 2, l = 4, b = 20, r = 20),\n           area(t = 1, l = 1, b = 6, r = 6))\n\nplot(design)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncombined_bi_var_plot <- transit_bi_var_plot + bi_var_legend_new +\n  plot_layout(design = design) +\n  plot_annotation(title = \"Allegheny County Commuter Patterns\",\n                  subtitle = \"Legend: % of commuters that drove alone or use public transit\",\n                  caption = \"2019 American Community Survey\",\n                  theme = theme(panel.background = element_rect(fill = \"black\"),\n                                plot.title = element_text(size = 30),\n                                plot.subtitle = element_text(size = 25),\n                                plot.caption = element_text(size = 25)))\n```\n:::\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](images/combined_bi_var_transit.png){width=4500}\n:::\n:::\n\n\n#### Links:\n\n-   <https://www.pghcitypaper.com/pittsburgh/low-income-pittsburghers-are-becoming-increasingly-reliant-on-public-transit-bikes-walking-and-alternative-transportation/Content?oid=19059768>\n-   <https://www.pghcitypaper.com/pittsburgh/new-commutes-analyzing-the-changing-ways-pittsburghers-get-to-work/Content?oid=6405396>\n-   <https://www.pghcitypaper.com/pittsburgh/pittsburgh-is-the-7th-least-car-dependent-metro-in-america-study-says/Content?oid=16755873>\n-   <https://www.nytimes.com/2020/07/09/opinion/sunday/ban-cars-manhattan-cities.html>\n-   <https://www.nytimes.com/2021/03/25/climate/buses-trains-ridership-climate-change.html>\n-   <https://nacto.org/publication/transit-street-design-guide/introduction/why/designing-move-people/>\n-   <https://rweekly.org/>\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}