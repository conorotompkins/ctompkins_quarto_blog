{
  "hash": "acd21f34df169a2ddf4d034d8b5574fb",
  "result": {
    "markdown": "---\ntitle: \"Cumulative eBird Sightings in Allegheny County\"\nauthor: \"Conor Tompkins\"\nsubtitle: \"\"\nsummary: \"\"\nauthors: [Conor Tompkins]\ntags: [R]\ncategories: [R]\ndate: 2020-04-29\nlastmod: 2020-08-07T13:47:31-04:00\nfeatured: false\ndraft: false\n# Focal points: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight.\nimage: cumulative_observations.gif\nprojects: []\neditor_options: \n  chunk_output_type: console\nexecute:\n  echo: true\n  warning: false\n  message: false\n---\n\n\nThis will be a quick post on cumulative bird observations in Allegheny County. Cumulative graphs show overall trends, seasonality, and quirks in how the data was recorded. They are also fun to turn into animated gifs with `gganimate`. \n\nLoad the relevant libraries:\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(tidyquant)\nlibrary(janitor)\nlibrary(hrbrthemes)\nlibrary(vroom)\nlibrary(ggrepel)\nlibrary(gganimate)\n\nset.seed(1234)\n\ntheme_set(theme_bw(base_size = 16))\n```\n:::\n\n\nThis reads in data from the [eBird data portal](https://ebird.org/data/download):\n\n::: {.cell hash='index_cache/html/unnamed-chunk-2_87d40bd929a62dbfe27313123bc30481'}\n\n```{.r .cell-code}\ndf <- vroom(\"post_data/ebd_US-PA-003_201001_202003_relFeb-2020.zip\", delim = \"\\t\") %>% \n  clean_names() %>% \n  mutate_at(vars(observer_id, locality, observation_date, time_observations_started, protocol_type), str_replace_na, \"NA\") %>% \n  mutate(observation_count = as.numeric(str_replace(observation_count, \"X\", as.character(NA))),\n         observation_event_id = str_c(observer_id, locality, observation_date, time_observations_started, sep = \"-\"),\n         observation_date = ymd(observation_date)) %>%\n  filter(all_species_reported == 1)\n\nglimpse(df)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 908,622\nColumns: 48\n$ global_unique_identifier     <chr> \"URN:CornellLabOfOrnithology:EBIRD:OBS815…\n$ last_edited_date             <dttm> 2018-08-03 11:44:16, 2018-08-03 11:44:34…\n$ taxonomic_order              <dbl> 493, 20638, 20638, 20638, 20638, 20638, 2…\n$ category                     <chr> \"species\", \"species\", \"species\", \"species…\n$ common_name                  <chr> \"American Black Duck\", \"American Crow\", \"…\n$ scientific_name              <chr> \"Anas rubripes\", \"Corvus brachyrhynchos\",…\n$ subspecies_common_name       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ subspecies_scientific_name   <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ observation_count            <dbl> 1, 7, 3, 2, 4, 3, NA, NA, 25, 2, 7, 2, 3,…\n$ breeding_bird_atlas_code     <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ breeding_bird_atlas_category <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ age_sex                      <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ country                      <chr> \"United States\", \"United States\", \"United…\n$ country_code                 <chr> \"US\", \"US\", \"US\", \"US\", \"US\", \"US\", \"US\",…\n$ state                        <chr> \"Pennsylvania\", \"Pennsylvania\", \"Pennsylv…\n$ state_code                   <chr> \"US-PA\", \"US-PA\", \"US-PA\", \"US-PA\", \"US-P…\n$ county                       <chr> \"Allegheny\", \"Allegheny\", \"Allegheny\", \"A…\n$ county_code                  <chr> \"US-PA-003\", \"US-PA-003\", \"US-PA-003\", \"U…\n$ iba_code                     <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ bcr_code                     <dbl> 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 2…\n$ usfws_code                   <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ atlas_block                  <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ locality                     <chr> \"Rachel Carson Riverfront Park\", \"Southsi…\n$ locality_id                  <chr> \"L2640334\", \"L841018\", \"L329082\", \"L69207…\n$ locality_type                <chr> \"H\", \"H\", \"H\", \"P\", \"P\", \"H\", \"H\", \"H\", \"…\n$ latitude                     <dbl> 40.53731, 40.43124, 40.54348, 40.65688, 4…\n$ longitude                    <dbl> -79.79531, -79.97032, -79.90623, -80.1138…\n$ observation_date             <date> 2010-01-14, 2010-01-31, 2010-01-23, 2010…\n$ time_observations_started    <chr> \"11:05:00\", \"16:45:00\", \"13:15:00\", \"14:4…\n$ observer_id                  <chr> \"obsr39944\", \"obsr197993\", \"obsr197993\", …\n$ sampling_event_identifier    <chr> \"S5760087\", \"S5839167\", \"S5798726\", \"S580…\n$ protocol_type                <chr> \"Traveling\", \"Traveling\", \"Area\", \"Travel…\n$ protocol_code                <chr> \"P22\", \"P22\", \"P23\", \"P22\", \"P21\", \"P23\",…\n$ project_code                 <chr> \"EBIRD\", \"EBIRD\", \"EBIRD\", \"EBIRD\", \"EBIR…\n$ duration_minutes             <dbl> 25, 30, 90, 90, 120, 30, 35, 30, 70, 60, …\n$ effort_distance_km           <dbl> 0.483, 0.483, NA, 8.047, NA, NA, NA, NA, …\n$ effort_area_ha               <dbl> NA, NA, 24.2811, NA, NA, 4.0469, 4.0469, …\n$ number_observers             <dbl> 1, 2, 2, 1, NA, 2, 2, 2, 4, 2, 1, 1, 1, 4…\n$ all_species_reported         <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ group_identifier             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ has_media                    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ approved                     <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ reviewed                     <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ reason                       <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ trip_comments                <chr> NA, NA, NA, NA, NA, \"Temperature 8F Winds…\n$ species_comments             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ x47                          <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ observation_event_id         <chr> \"obsr39944-Rachel Carson Riverfront Park-…\n```\n:::\n:::\n\n\nI focus on the two main ways people use the eBird app: traveling and stationary. I also filter to only observations from 2016 onwards, since that is when eBird usage became stable in the county.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_top_protocols <- df %>% \n  count(protocol_type, sort = TRUE) %>% \n  slice(1:2)\n\ndf <- df %>% \n  semi_join(df_top_protocols) %>% \n  filter(year(observation_date) >= 2016)\n```\n:::\n\n\nThis identifies the top 10 birds in terms of total observations:\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_species_count <- df %>% \n  group_by(common_name) %>% \n  summarize(observation_count = sum(observation_count, na.rm = TRUE)) %>% \n  arrange(desc(observation_count)) %>% \n  slice(1:10)\n```\n:::\n\n\nThis code filters on the top 10 birds and caculates the cumulative number of sightings and the rolling 21 day average of sightings.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_cumulative <- df %>% \n  semi_join(df_species_count, by = c(\"common_name\")) %>% \n  group_by(common_name, observation_date) %>% \n  summarize(observation_count = sum(observation_count, na.rm = TRUE)) %>% \n  ungroup() %>% \n  arrange(common_name, observation_date) %>% \n  group_by(common_name) %>% \n  mutate(observation_count_cumulative = cumsum(observation_count)) %>% \n  tq_mutate(\n    # tq_mutate args\n    select     = observation_count,\n    mutate_fun = rollapply, \n    # rollapply args\n    width      = 21,\n    align      = \"right\",\n    FUN        = mean,\n    # mean args\n    na.rm      = TRUE,\n    # tq_mutate args\n    col_rename = \"mean_21\"\n  )\n```\n:::\n\n\nThis plots the cumulative observations by bird and creates an animation with `gganimate`:\n\n::: {.cell}\n\n```{.r .cell-code}\nplot <- df_cumulative %>% \n  ggplot(aes(observation_date, observation_count_cumulative, group = common_name)) +\n  geom_line(alpha = .5) +\n  geom_segment(aes(xend = last(df_cumulative$observation_date) + 240, yend = observation_count_cumulative), linetype = 2, colour = 'grey') +\n  geom_point(aes(size = mean_21)) +\n  geom_label(aes(x = last(df_cumulative$observation_date) + 210, label = common_name), size = 6) +\n  scale_y_comma() +\n  scale_size_continuous(\"21 day rolling average of observation count\", range = c(2, 10), labels = scales::comma) +\n  scale_x_date(limits = c(first(df_cumulative$observation_date), last(df_cumulative$observation_date) + 250)) +\n  labs(x = NULL,\n       y = \"Cumulative observations\",\n       title = \"eBird observations in Allegheny County\",\n       subtitle = \"Top 10 birds 2016 through January 2020\",\n       caption = \"@conor_tompkins\") +\n  coord_cartesian(clip = 'off') +\n  transition_reveal(observation_date)\n\nplot\n```\n:::\n\n![](cumulative_observations.gif)",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}