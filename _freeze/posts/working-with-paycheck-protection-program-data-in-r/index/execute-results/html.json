{
  "hash": "4ae0a90d5bbadbfe89a7ddc773cb9a16",
  "result": {
    "markdown": "---\ntitle: Working with Paycheck Protection Program data in R\nauthor: Conor Tompkins\ndate: '2020-07-08'\nslug: working-with-paycheck-protection-program-data-in-r\nimage: preview.png\ncategories:\n  - R\n  - politics\ntags:\n  - COVID\nexecute: \n  message: false\n  warning: false\neditor_options: \n  chunk_output_type: console\n---\n\n\nIn this post, I walk through the process of reading in the data from the Paycheck Protection Program, and show some basic analyses that can be done.\n\n**This post was migrated to Quarto in April 2024. The SBA significantly restructured how the data is structured between 2020-2024, so some of the older analyis is no longer applicable.**\n\nLoad packages and set up environment:\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(vroom)\nlibrary(sf)\nlibrary(tigris)\nlibrary(lubridate)\nlibrary(janitor)\nlibrary(hrbrthemes)\nlibrary(scales)\n\ntheme_set(theme_ipsum(base_size = 18))\n\noptions(scipen = 999, digits = 4, tigris_use_cache = TRUE)\n```\n:::\n\n\n## Load and clean data\n\nThe data is available at this site: https://data.sba.gov/dataset/ppp-foia\n\nThe data exists in numerous CSV files, separated by state and sometimes loan amount. \n\nThis code chunk identifies all the CSV files in the folder, reads them in, and combines them.\n\n::: {.cell}\n\n```{.r .cell-code}\npath <- \"posts/working-with-paycheck-protection-program-data-in-r/post_data/ppp\"\n\n#find all files in the folder that end in .csv\nppp_files <- list.files(path, full.names = TRUE, recursive = TRUE) %>% \n  keep(str_detect(., \".csv$\")) %>% \n  #read each file with read_csv and combine them\n  set_names()\n\nppp_files |> \n  pluck(1) |> \n  read_csv(n_max = 100) |> \n  glimpse()\n\nread_and_filter <- function(x){\n  \n  print(x)\n  \n  read_csv(x, col_types = cols(.default = \"c\")) |> \n    filter(mdy(DateApproved) < \"2020-07-01\") |> \n    clean_names()\n  \n}\n\nppp_data <- ppp_files |> \n  map(read_and_filter)\n\nppp_data |>\n  pluck(1)\n\nglimpse(ppp_data)\n\nlist_rbind(ppp_data, names_to = \"file_name\") |> \n  write_csv(\"posts/working-with-paycheck-protection-program-data-in-r/post_data/combined_ppp.csv\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined <- vroom(\"post_data/combined_ppp.csv\", delim = \",\") %>%\n  mutate(date_approved = mdy(date_approved)) |> \n  mutate(loan_range = cut(current_approval_amount,\n                          breaks = c(0, 150000, 350000, 1000000, 2000000, 5000000, 10000000),\n                          labels = c(\"Under $150k\", \"$150k-$350k\", \"$350k-$1 million\", \"$1 million-$2 million\", \"$2 million-$5 million\", \"$5 million-$10 million\"))) |> \n  separate(cd, into = c(\"state_2\", \"district\"), remove = FALSE)\n```\n:::\n\n\nThis changes how the columns are interpreted, and separates the congressional district column into state and district. If the `district` value is blank, I replace it with `NA`.\n\n\n\n\nThere are cases where the value in the `state` column doesn't match the state embedded in the congressional district `cd` column. \n\n::: {.cell}\n\n```{.r .cell-code}\n#preview data where state doesn't match congressional district\nppp_combined %>% \n  count(file_name, project_state, cd, state_2, sort = TRUE) %>% \n  mutate(flag_match = project_state == state_2) %>% \n  filter(flag_match == FALSE) %>% \n  slice(1:5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 5 × 6\n  file_name                         project_state cd    state_2     n flag_match\n  <chr>                             <chr>         <chr> <chr>   <int> <lgl>     \n1 posts/working-with-paycheck-prot… MI            MT-02 MT         18 FALSE     \n2 posts/working-with-paycheck-prot… MN            MT-02 MT         15 FALSE     \n3 posts/working-with-paycheck-prot… NE            SD-   SD          4 FALSE     \n4 posts/working-with-paycheck-prot… NY            NJ-05 NJ          4 FALSE     \n5 posts/working-with-paycheck-prot… TX            NM-03 NM          3 FALSE     \n```\n:::\n:::\n\n\nThere are only 423 rows where this occurs, and it is less than 1% of the dataset.\n\n::: {.cell}\n\n```{.r .cell-code}\n#summarize cases where mismatch occurs\nppp_combined %>% \n  mutate(flag_match = project_state == state_2) %>% \n  count(flag_match) %>% \n  mutate(pct_mismatch = n / sum(n),\n         pct_mismatch = round(pct_mismatch, 4)) %>% \n  filter(flag_match == FALSE) %>% \n  arrange(-pct_mismatch)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 3\n  flag_match     n pct_mismatch\n  <lgl>      <int>        <dbl>\n1 FALSE        423       0.0001\n```\n:::\n:::\n\n\nI filter out the rows where the state doesn't match the congressional district.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined |> \n  filter(project_state != state_2) |> \n  distinct(project_state, state_2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 236 × 2\n   project_state state_2\n   <chr>         <chr>  \n 1 AL            WA     \n 2 AL            FL     \n 3 AZ            TX     \n 4 CA            ME     \n 5 CA            FL     \n 6 CA            AP     \n 7 CT            NJ     \n 8 FL            TX     \n 9 FL            WV     \n10 FL            CA     \n# ℹ 226 more rows\n```\n:::\n\n```{.r .cell-code}\nppp_combined <- ppp_combined %>% \n  filter(project_state == state_2)\n```\n:::\n\n\nThis shows that there are some negative values in `loan_amount`. I filter out those values.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined %>% \n  mutate(loan_type = current_approval_amount > 0) %>% \n  count(loan_type)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 2\n  loan_type       n\n  <lgl>       <int>\n1 FALSE           1\n2 TRUE      4811540\n```\n:::\n\n```{.r .cell-code}\nppp_combined <- ppp_combined %>% \n  filter(current_approval_amount > 0, !is.na(current_approval_amount))\n```\n:::\n\n\n## Analysis\n### Loan amount\n\nThe first step is to split the data into 2 buckets. For loans above $150k, the SBA binned the loan amount instead of reporting the actual value.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_under_150 <- ppp_combined %>% \n  filter(!str_detect(file_name, \"150k_plus\"))\n\nppp_over_150 <- ppp_combined %>% \n  filter(str_detect(file_name, \"150k_plus\"))\n```\n:::\n\n\nAmong loans less than 150k, most are less than 21k, and the distribution is very heavily skewed to the right. \n\n::: {.cell}\n\n```{.r .cell-code}\nquantiles <- ppp_under_150 %>% \n  reframe(quantiles = quantile(current_approval_amount, probs = c(.25, .50, .75)), \n            probability = c(\"25th\", \"50th\", \"75th\")) %>% \n  mutate(probability = as.factor(probability))\n\nppp_under_150 %>% \n  ggplot(aes(current_approval_amount)) +\n  geom_histogram() +\n  geom_vline(data = quantiles, aes(xintercept = quantiles, color = probability)) +\n  scale_y_comma() +\n  scale_x_comma(labels = scales::dollar) +\n  labs(title = \"SBA PPP Loans\",\n       subtitle = \"Among loans less than $150k\",\n       x = \"Loan amount\",\n       y = \"Number of loans\",\n       color = \"Quantile\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nLoans under $150k make up the vast majority of all PPP loans.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined |> \n  count(loan_range) %>%   \n  mutate(loan_range = fct_reorder(loan_range, n)) %>% \n  ggplot(aes(n, loan_range)) +\n  geom_col() +\n  labs(title = \"SBA PPP Loans\",\n       subtitle = \"All loans\",\n       x = \"Number of loans\",\n       y = \"Loan range\") +\n  scale_x_comma()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nLoan approvals peaked in late April 2020 when the program began accepting applications for the second round, and picked up in July. There is extreme weekday-weekend seasonality in the data after April. The \"U\" shape from May to July generally coincides with the effort to \"reopen\" economies nationwide.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined %>% \n  count(date_approved) %>% \n  ggplot(aes(date_approved, n)) +\n  geom_point() +\n  geom_vline(xintercept = ymd(\"2020-04-16\"), linetype = 2) +\n  labs(title = \"SBA PPP Loans\",\n       x = NULL,\n       y = \"Number of loans\") +\n  scale_y_comma()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nThis shows that bigger loans tended to be approved earlier in the program, which was a major criticism.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined %>% \n  count(date_approved, loan_range) %>% \n  mutate(loan_range = fct_reorder(loan_range, n) %>% fct_rev) %>% \n  group_by(date_approved) %>% \n  mutate(pct_of_loans = n / sum(n)) %>% \n  ungroup() %>% \n  ggplot(aes(date_approved, pct_of_loans, color = loan_range)) +\n  geom_line() +\n  scale_x_date(expand = c(0,0)) +\n  scale_y_percent(limits = c(0,1.1)) +\n  scale_color_viridis_d() +\n  labs(title = \"SBA PPP Loans\",\n       subtitle = \"% of loans approved on a date\",\n       x = NULL,\n       y = \"% of loans\",\n       fill = \"Loan range\") +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\nMost states received similar proportions of small and large loans. Territories received more small loans and fewer large loans.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined %>% \n  mutate(loan_range = fct_inorder(loan_range)) %>% \n  count(project_state, loan_range) %>% \n  group_by(project_state) %>% \n  mutate(pct_of_loans = n / sum(n)) %>% \n  ungroup() %>% \n  filter(!is.na(project_state)) %>% \n  mutate(project_state = fct_reorder(project_state, n, .fun = sum)) %>% \n  ggplot(aes(pct_of_loans, project_state, fill = loan_range)) +\n  geom_col() +\n  scale_fill_viridis_d(direction = -1) +\n  scale_x_percent() +\n  labs(title = \"SBA PPP Loans\",\n       subtitle = \"% of loan range by state\",\n       x = \"% of loans\",\n       y = NULL,\n       fill = \"Loan range\") +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n### Jobs\n\nBigger loans tended to retain more jobs.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined %>% \n  filter(!is.na(jobs_reported)) %>% \n  mutate(loan_range = fct_inorder(loan_range) %>% fct_rev()) %>% \n  ggplot(aes(jobs_reported, fill = loan_range)) +\n  #geom_histogram(bins = 200) +\n  geom_density() +\n  facet_wrap(~loan_range, ncol = 2, scales = \"free\") +\n  scale_x_comma() +\n  #scale_y_comma() +\n  scale_fill_viridis_d() +\n  labs(title = \"SBA PPP Loan Program\",\n       subtitle = \"Jobs retained\",\n       x = \"Number of jobs retained\",\n       y = \"Density\",\n       fill = \"Loan range\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=960}\n:::\n:::\n\n\nThe timeline of `jobs_reported` closely matches the trend of when loans were approved.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined %>% \n  filter(!is.na(jobs_reported)) %>% \n  group_by(date_approved) %>% \n  summarize(jobs_reported = sum(jobs_reported)) %>% \n  ungroup() %>% \n  ggplot(aes(date_approved, jobs_reported)) +\n  geom_point() +\n  scale_y_comma() +\n  labs(title = \"SBA PPP Loan Program\",\n       subtitle = \"Jobs Retained\",\n       x = NULL,\n       y = \"Jobs retained\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nAmong loans less than 150k and where the data was reported, the median loan retained 7 jobs per 50k spent. Systemic reporting bias probably makes this number less reliable.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_combined %>% \n  filter(loan_range == \"Under $150k\",\n         !is.na(jobs_reported),\n         !is.na(current_approval_amount)) %>% \n  select(jobs_reported, current_approval_amount) %>% \n  mutate(jobs_retained_per_50k = (jobs_reported / current_approval_amount) * 50000) %>% \n  summarize(jobs_retained_per_50k = median(jobs_retained_per_50k))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 1\n  jobs_retained_per_50k\n                  <dbl>\n1                  7.11\n```\n:::\n:::\n\n\nIn the same loan range, bigger loans generally meant more jobs retained.\n\n::: {.cell hash='index_cache/html/unnamed-chunk-18_c3b5c7ab699a7cad5512a0c3d9a16d0d'}\n\n```{.r .cell-code}\ntest <- ppp_combined %>% \n  filter(loan_range == \"Under $150k\") %>% \n  count(current_approval_amount, jobs_reported, sort = TRUE) %>%\n  slice(1:5000)\n\ntest %>% \n  ggplot(aes(current_approval_amount, jobs_reported)) +\n  geom_density_2d_filled() +\n  scale_x_comma(labels = scales::dollar) +\n  labs(title = \"SBA PPP Loan Program\",\n       subtitle = NULL,\n       x = \"Loan amount\",\n       y = \"Jobs retained\",\n       fill = \"Density of observations\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n### Mapping the data\n\nThe dataset identifies which federal congressional district the applicant is from. I use `tigris` to retrieve the shapefiles for the most recent districts.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncongress_districts <- suppressMessages(congressional_districts(cb = TRUE, resolution = \"500k\", year = 2020)) %>% \n  st_as_sf() %>% \n  clean_names() %>% \n  filter(statefp == 42)\n```\n:::\n\n\nThis counts how many of each `loan_range` a `district` received. Note that there are missing values and what appear to be defunct district IDs in the `district` column.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_pa_districts_loan_range <- ppp_combined %>% \n  filter(project_state == \"PA\") %>% \n  count(cd, loan_range, sort = TRUE)\n\nppp_pa_districts_loan_range %>% \n  mutate(cd = fct_explicit_na(cd),\n         cd = fct_reorder(cd, n, .fun = sum)) %>% \n  ggplot(aes(n, cd, fill = loan_range)) +\n  geom_col() +\n  scale_x_comma() +\n  scale_fill_viridis_d() +\n  labs(title = \"SBA PPP Loan Program\",\n       subtitle = \"Pennsylvania\",\n       x = \"Number of loans\",\n       y = \"Congressional District\",\n       fill =  \"Loan range\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\nDistricts in eastern Pennsylvania near Philadelphia received more loans from the program.\n\n::: {.cell}\n\n```{.r .cell-code}\nppp_pa_districts <- ppp_combined %>% \n  filter(project_state == \"PA\") %>% \n  count(district, sort = TRUE)\n\ncongress_districts %>% \n  right_join(ppp_pa_districts, by = c(\"cd116fp\" = \"district\")) %>% \n  ggplot() +\n  geom_sf(aes(fill = n)) +\n  scale_fill_viridis_c(option = \"A\", labels = scales::comma) +\n  labs(title = \"SBA PPP Loan Program\",\n       subtitle = \"Pennsylvania\",\n       fill = \"Number of loans\") +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}