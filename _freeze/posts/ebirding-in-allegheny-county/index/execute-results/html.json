{
  "hash": "bdaced35bd7292d4ae5d4838ba5a8799",
  "result": {
    "markdown": "---\ntitle: \"eBirding in Allegheny County\"\nsubtitle: \"\"\nsummary: \"\"\nauthors: [Conor Tompkins]\ntags: [R]\ncategories: [R]\ndate: 2020-04-18\nlastmod: 2020-08-08T09:07:00-04:00\nfeatured: false\ndraft: false\n# Focal points: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight.\nimage: featured.png\nprojects: []\neditor_options: \n  chunk_output_type: console\nexecute:\n  echo: true\n  warning: false\n  message: false\n---\n\n\nIn this post I will do some exploratory analysis on eBird data. I've picked up birdwatching as a hobby during quarantine, and eBird has a ton of [cool data on bird sightings](https://ebird.org/data/download).\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(vroom)\nlibrary(janitor)\nlibrary(rebird)\nlibrary(hrbrthemes)\nlibrary(ggrepel)\nlibrary(gganimate)\nlibrary(widyr)\nlibrary(tidygraph)\nlibrary(ggraph)\nlibrary(tidytext)\n\noptions(scipen = 999, digits = 2)\n\ntheme_set(theme_ipsum())\n\nset.seed(1234)\n```\n:::\n\n\n## Load and filter data\n\nI downloaded data for bird sightings in Allegheny County from the eBird data portal. This code loads the data in R and prepares it for analysis.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- vroom(\"post_data/ebd_US-PA-003_201001_202003_relFeb-2020.zip\", delim = \"\\t\") %>% \n  clean_names() %>% \n  mutate_at(vars(observer_id, locality, observation_date, time_observations_started, protocol_type), str_replace_na, \"NA\") %>% \n  mutate(observation_date = ymd(observation_date),\n         observation_count_old = observation_count,\n         observation_count = as.numeric(str_replace(observation_count_old, \"X\", as.character(NA))),\n         observation_event_id = str_c(observer_id, locality, observation_date, time_observations_started)) %>% \n  filter(all_species_reported == 1)\n```\n:::\n\n\nI will focus on the two major \"types\" of observation protocols. The others are related to specific birding events, and might not be representative of the overall data.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_top_protocols <- df %>% \n  count(protocol_type, sort = TRUE) %>% \n  slice(1:2)\n\ndf_top_protocols\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 2\n  protocol_type      n\n  <chr>          <int>\n1 Traveling     545872\n2 Stationary    293991\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- df %>% \n  semi_join(df_top_protocols)\n```\n:::\n\n\nThis shows that Allegheny County birders began submitting data regularly in 2016. I will focus my analysis on recent observations.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  count(observation_date) %>% \n  mutate(recent_observation = year(observation_date) >= 2016,\n         observation_date = ymd(observation_date)) %>% \n  ggplot(aes(observation_date, n, color = recent_observation)) +\n    geom_line() +\n    scale_y_comma() +\n    scale_color_discrete(\"Recent Observation\") +\n    labs(y = \"Number of observations\",\n         x = \"Observation date\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- df %>% \n  filter(year(observation_date) >= 2016)\n```\n:::\n\n\nThere is wide variation in the number of times a species was sighted in a given observation.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  ggplot(aes(observation_count, group = common_name)) +\n    geom_density() +\n    scale_x_log10() +\n    labs(x = \"Species count (log10)\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nThis calculates the 99th percentile of bird count per observation, and highlights the birds that are seen in large flocks.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  group_by(common_name) %>% \n  summarize(observation_count_99 = quantile(observation_count, probs = c(.99), na.rm = TRUE)) %>% \n  arrange(desc(observation_count_99))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 306 × 2\n   common_name       observation_count_99\n   <chr>                            <dbl>\n 1 Ring-billed Gull                 3400 \n 2 crow sp.                         2000 \n 3 gull sp.                          500 \n 4 Herring Gull                      248.\n 5 Tundra Swan                       230.\n 6 European Starling                 176.\n 7 Horned Lark                       175 \n 8 Bufflehead                        170.\n 9 Canada Goose                      148 \n10 Larus sp.                         143.\n# ℹ 296 more rows\n```\n:::\n:::\n\n\nThis shows that the high count of Ring-billed Gulls is explained by groups of birders seeing flocks of thousands of the species. This also highlights that the same bird sighting can be counted twice because of simultaneous observation.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  filter(common_name == \"Ring-billed Gull\") %>% \n  arrange(desc(observation_count)) %>% \n  slice(1:10) %>% \n  select(observer_id, group_identifier, common_name, observation_date, duration_minutes, observation_count, locality)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10 × 7\n   observer_id group_identifier common_name    observation_date duration_minutes\n   <chr>       <chr>            <chr>          <date>                      <dbl>\n 1 obsr160352  G2943178         Ring-billed G… 2018-02-13                     38\n 2 obsr40545   G2943178         Ring-billed G… 2018-02-13                     38\n 3 obsr40545   G2930894         Ring-billed G… 2018-02-09                     50\n 4 obsr160352  G2930894         Ring-billed G… 2018-02-09                     75\n 5 obsr160352  <NA>             Ring-billed G… 2016-01-29                     25\n 6 obsr160352  G1578214         Ring-billed G… 2016-01-30                     71\n 7 obsr101818  G1578214         Ring-billed G… 2016-01-30                     71\n 8 obsr40545   G2940041         Ring-billed G… 2018-02-12                     55\n 9 obsr160352  <NA>             Ring-billed G… 2018-02-10                     55\n10 obsr620338  G2940041         Ring-billed G… 2018-02-12                     55\n# ℹ 2 more variables: observation_count <dbl>, locality <chr>\n```\n:::\n:::\n\n\n## Species counts\n\nThis does a basic count of the major species, not accounting for simultaneous observation:\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_counts <- df %>% \n  group_by(common_name) %>% \n  summarize(species_count = sum(observation_count, na.rm = TRUE)) %>% \n  arrange(desc(species_count))\n\ndf_counts\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 306 × 2\n   common_name       species_count\n   <chr>                     <dbl>\n 1 Ring-billed Gull         253373\n 2 American Crow            189804\n 3 European Starling        180456\n 4 American Robin           180148\n 5 Canada Goose             159040\n 6 Mallard                  103066\n 7 Northern Cardinal         84604\n 8 Mourning Dove             70975\n 9 Blue Jay                  64894\n10 Song Sparrow              63571\n# ℹ 296 more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_counts %>% \n  mutate(common_name = fct_reorder(common_name, species_count)) %>% \n  slice(1:20) %>% \n  ggplot(aes(species_count, common_name)) +\n    geom_col() +\n    scale_x_comma() +\n    labs(x = \"Observations\",\n         y = NULL)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n## Species correlations\n\nI was interested in which birds are correlated most with two common and popular birds, the Cardinal and the Blue Jay. This calculates the pairwise correlation and plots the top 10 birds correlated with the two target species:\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_list <- c(\"Northern Cardinal\", \"Blue Jay\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_pair_corr <- df %>% \n  pairwise_cor(common_name, observation_event_id, diag = FALSE, upper = FALSE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_pair_corr %>% \n  filter(item1 %in% species_list) %>% \n  drop_na(correlation) %>% \n  arrange(item1, desc(correlation)) %>% \n  group_by(item1) %>% \n  slice(1:10) %>% \n  ungroup() %>% \n  mutate(item2 = reorder_within(x = item2, by = correlation, within = item1)) %>% \n  ggplot(aes(correlation, item2, fill = item1)) +\n    geom_col(alpha = .9) +\n    facet_wrap(~item1, scales = \"free_y\") +\n    scale_y_reordered() +\n    scale_fill_manual(values = c(\"blue\", \"red\")) +\n    guides(fill = FALSE) +\n    labs(x = \"Correlation\",\n         y = NULL)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=960}\n:::\n:::\n\n\nCardinals and Blue Jays share many birds in common, but there are some distinctions, and the level of correlation can vary. I use a slopegraph to show the difference in how much a bird is correlated with Blue Jays vs. Cardinals.\n\nThis grabs the data for the two target species and gets the top 20 correlated birds for each species:\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_slopegraph <- df_pair_corr %>% \n  filter(item1 %in% species_list) %>% \n  drop_na(correlation) %>% \n  arrange(item1, desc(correlation)) %>% \n  group_by(item1) %>% \n  slice(1:20) %>% \n  ungroup()\n```\n:::\n\n\nThis calculates the difference in correlation for each bird: \n\n::: {.cell}\n\n```{.r .cell-code}\ndf_corr_diff <- df_slopegraph %>% \n  pivot_wider(names_from = item1, values_from = correlation, names_prefix = \"corr_\") %>% \n  clean_names() %>% \n  mutate(corr_diff = abs(corr_blue_jay - corr_northern_cardinal)) %>% \n  select(item2, corr_diff)\n\ndf_corr_diff\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 31 × 2\n   item2                   corr_diff\n   <chr>                       <dbl>\n 1 Northern Cardinal        NA      \n 2 Red-bellied Woodpecker    0.0347 \n 3 Tufted Titmouse           0.0142 \n 4 Carolina Wren            NA      \n 5 Downy Woodpecker         NA      \n 6 White-breasted Nuthatch   0.00495\n 7 Song Sparrow              0.118  \n 8 Northern Flicker          0.0199 \n 9 Mourning Dove            NA      \n10 Eastern Towhee           NA      \n# ℹ 21 more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_slopegraph %>% \n  left_join(df_corr_diff) %>% \n  ggplot(aes(item1, correlation)) +\n    geom_line(aes(group = item2, color = corr_diff), size = 2) +\n    geom_point(size = 2) +\n    geom_text_repel(data = filter(df_slopegraph, item1 == species_list[2]),\n                    aes(y = correlation, label = item2), direction = \"both\", nudge_x = -.3, segment.alpha = .2) +\n    geom_text_repel(data = filter(df_slopegraph, item1 == species_list[1]),\n                    aes(y = correlation, label = item2), direction = \"both\", nudge_x = .3, segment.alpha = .2) +\n    scale_color_viridis_c(\"Absolute difference in correlation\") +\n    labs(x = NULL,\n         y = \"Correlation\") +\n    theme(panel.grid.minor.y = element_blank(),\n          panel.grid.major.y = element_blank(),\n          axis.title.x = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-17-1.png){width=1536}\n:::\n:::\n\n\n## Network Graph\n\nNetwork graphs are fun ways to show counts or correlations between groups. Since birds often exist in distinct environments and vary by season, graph analysis should be able to visualize connections.\n\nThis takes the top 100 birds in terms of total count and makes a network graph object consisting of nodes and edges.\n\n::: {.cell}\n\n```{.r .cell-code}\ngraph_object_corr <- df_pair_corr %>% \n  semi_join(df_counts %>% slice(1:75), by = c(\"item1\" = \"common_name\")) %>% \n  semi_join(df_counts %>% slice(1:75), by = c(\"item2\" = \"common_name\")) %>% \n  as_tbl_graph(directed = FALSE) %>% \n  activate(nodes) %>% \n  filter(!node_is_isolated()) %>% \n  activate(edges) %>% \n  filter(abs(correlation) >= .05) %>% \n  activate(nodes) %>% \n  filter(!node_is_isolated()) %>% \n  left_join(df_counts, by = c(\"name\" = \"common_name\"))\n\ngraph_object_corr\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tbl_graph: 74 nodes and 1925 edges\n#\n# An undirected simple graph with 1 component\n#\n# Node Data: 74 × 2 (active)\n   name                   species_count\n   <chr>                          <dbl>\n 1 American Crow                 189804\n 2 American Goldfinch             60297\n 3 American Robin                180148\n 4 Belted Kingfisher               2754\n 5 Black-capped Chickadee         12379\n 6 Blue Jay                       64894\n 7 Brown-headed Cowbird            8877\n 8 Bufflehead                      5758\n 9 Canada Goose                  159040\n10 Carolina Chickadee             21862\n# ℹ 64 more rows\n#\n# Edge Data: 1,925 × 3\n   from    to correlation\n  <int> <int>       <dbl>\n1     1     2       0.262\n2     1     3       0.259\n3     2     3       0.371\n# ℹ 1,922 more rows\n```\n:::\n:::\n\n\nThis plots the network graph to show all the connections that fit the criteria in the code above:\n\n::: {.cell}\n\n```{.r .cell-code}\nplot <- graph_object_corr %>% \n    ggraph() +\n    geom_edge_link(aes(width = correlation, alpha = correlation)) +\n    geom_node_point(aes(size = species_count, alpha = species_count)) +\n    scale_size_continuous(\"Total observations\", labels = scales::comma) +\n    scale_alpha_continuous(\"Total observations\", labels = scales::comma) +\n    scale_edge_alpha(\"Observations together\", range = c(.01, .3)) +\n    scale_edge_width(\"Observations together\", range = c(.1, 2)) +\n    theme_void()\n\nplot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){width=960}\n:::\n:::\n\n\nThere is a dense group of birds that are highly correlated with each other. This high correlation could be caused by a shared environment or seasonal migration patterns.\n\n### Highlight species\n\nI also wanted to  be able to see where a given species fits in the network graph. This code prepares a network graph object and filters out species that are not highly connected to the main group.\n\n::: {.cell}\n\n```{.r .cell-code}\ngraph_object_corr <- df_pair_corr %>% \n  as_tbl_graph(directed = FALSE) %>% \n  activate(edges) %>% \n  filter(abs(correlation) > .2) %>% \n  activate(nodes) %>% \n  mutate(centrality = centrality_authority()) %>% \n  filter(centrality > .01) %>% \n  filter(!node_is_isolated())\n```\n:::\n\n\nThis code identifies the node ID for the Northern Cardinal and makes a dataframe I will use to filter with in the next code chunk.\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_list <- c(\"Northern Cardinal\")\n\ndf_species_corr_nodes <- graph_object_corr %>% \n  activate(nodes) %>% \n  as_tibble() %>% \n  mutate(node_id = row_number()) %>% \n  filter(name %in% species_list)\n```\n:::\n\n\nThis code identifes which node is the Northern Cardinal, and which edges connect to the Northern Cardinal. This identifies all the species that are connected to the bird, given the criteria I set above.\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_corr <- graph_object_corr %>% \n  activate(nodes) %>% \n  mutate(name_label = case_when(name %in% species_list ~ name,\n                                TRUE ~ as.character(NA))) %>% \n  activate(edges) %>% \n  left_join(df_species_corr_nodes, by = c(\"from\" = \"node_id\")) %>% \n  left_join(df_species_corr_nodes, by = c(\"to\" = \"node_id\")) %>% \n  mutate(name = coalesce(name.x, name.y),\n         centrality = coalesce(name.x, name.y)) %>% \n  select(-matches(\".x|.y\")) %>% \n  mutate(species_flag = case_when(from %in% df_species_corr_nodes$node_id | to %in% df_species_corr_nodes$node_id ~ TRUE,\n                                  TRUE ~ FALSE),\n         name = case_when(is.na(name) ~ \"Other species\",\n                          TRUE ~ name)) %>%\n  ggraph() +\n    geom_edge_link(aes(alpha = species_flag, width = species_flag)) +\n    geom_node_point(aes(shape = !is.na(name_label), size = !is.na(name_label), color = name_label)) +\n    geom_node_label(aes(label = name_label, color = name_label), repel =  TRUE) +\n    scale_edge_width_manual(values = c(.3, 1)) +\n    scale_edge_alpha_discrete(range = c(0.1, .5)) +\n    scale_shape_manual(values = c(1, 19)) +\n    scale_size_manual(values = c(2, 3)) +\n    guides(edge_alpha = FALSE,\n           edge_width = FALSE,\n           size = FALSE,\n           shape = FALSE,\n           color = FALSE) +\n    theme_void()\n\nplot_corr\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-1.png){width=960}\n:::\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}