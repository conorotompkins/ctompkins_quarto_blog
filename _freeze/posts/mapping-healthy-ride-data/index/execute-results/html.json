{
  "hash": "749e51b3321c4d6d8b16f18e531c2964",
  "result": {
    "engine": "knitr",
    "markdown": "---\n# Documentation: https://sourcethemes.com/academic/docs/managing-content/\n\ntitle: \"Mapping Healthy Ride Data\"\nsubtitle: \"\"\nsummary: \"\"\nauthors: [Conor Tompkins]\ntags: [Pittsburgh, Healthy Ride]\ncategories: [Pittsburgh, Healthy Ride]\ndate: 2017-11-12\nlastmod: 2020-09-28T08:29:37-04:00\nfeatured: false\ndraft: false\nimage: featured.png\nexecute: \n  echo: true\n  warning: false\n  message: false\n---\n\n\nThis post is about mapping the Healthy Ride dataset in R.\n\nThis is my third post about the Healthy Ride bike service in Pittsburgh. You can find the [first post](https://ctompkins.netlify.com/2017/10/18/exploring-healthy-ride-pittsburgh-data/) and [second post](http://ctompkins.netlify.com/2017/11/05/healthy-ride-network-analysis/) on my blog.\n\nFirst, load the R packages we will be using:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(ggmap)\nlibrary(lubridate)\nlibrary(viridis)\nlibrary(stringr)\nlibrary(gghighlight)\nlibrary(knitr)\nlibrary(kableExtra)\n```\n:::\n\n\n\nThen load the data from the [WPRDC](https://data.wprdc.org/organization/healthy-ride) (hosted on [my GitHub page](https://github.com/conorotompkins)):\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- read_csv(\"https://raw.githubusercontent.com/conorotompkins/healthy_ride/master/data/data.csv\")\n```\n:::\n\n\n\nAgain, we need to format the data and the column names to make them more useful for analysis. Since this is a repeat of the script from the last post, I will just do it all in one go:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnames(data) <- tolower(colnames(data))\ncolnames(data) <- gsub(\" \", \"_\", colnames(data))\n\ndata_long <- data %>% \n  rename(start_date_time = starttime,\n         stop_date_time = stoptime) %>% \n  gather(date_time_type, date_time, c(start_date_time, stop_date_time)) %>% \n  select(date_time_type, date_time, everything()) %>% \n  mutate(date_time_2 = date_time) %>% \n  separate(date_time, \" \", into = c(\"date\", \"time\")) %>% \n  mutate(id = row_number(),\n         date = mdy(date),\n         year = year(date),\n         month = month(date, label = TRUE),\n         week = week(date),\n         time = hm(time),\n         hour = hour(time),\n         wday = wday(date, label = TRUE),\n         is_weekday = ifelse(wday %in% c(\"Mon\", \"Tues\", \"Wed\", \"Thurs\", \"Fri\"), \"weekday\", \"weekend\"),\n         yday = yday(date),\n         mday = mday(date)) %>% \n  mutate(trip_duration = (tripduration / 60) / 60) %>% \n  gather(station_id_type, station_id, c(from_station_id, to_station_id)) %>% \n  gather(station_name_type, station_name, c(from_station_name, to_station_name)) %>% \n  select(date_time_type, \n         is_weekday, \n         date, \n         year,\n         month,\n         hour,\n         wday,\n         yday,\n         mday,\n         date_time_2, \n         station_id_type, \n         station_id, \n         station_name_type,\n         station_name,\n         everything(),\n         -time)\n\ndata_long[1:10, 1:5] %>% \n  kable(\"html\") %>% \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\", \"responsive\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> date_time_type </th>\n   <th style=\"text-align:left;\"> is_weekday </th>\n   <th style=\"text-align:left;\"> date </th>\n   <th style=\"text-align:right;\"> year </th>\n   <th style=\"text-align:left;\"> month </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nImportantly, we will be excluding trips where the rider started and ended their trip at the same station. The data lacks the granularity to analyze rider location beyond the points where they began and ended their trip.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_long <- data_long %>% \n  spread(station_name_type, station_name) %>% \n  filter(from_station_name != to_station_name) %>% \n  gather(station_name_type, station_name, c(from_station_name, to_station_name))\n\ndata_long[1:10, 1:5] %>% \n  kable(\"html\") %>% \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\", \"responsive\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> date_time_type </th>\n   <th style=\"text-align:left;\"> is_weekday </th>\n   <th style=\"text-align:left;\"> date </th>\n   <th style=\"text-align:right;\"> year </th>\n   <th style=\"text-align:left;\"> month </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> start_date_time </td>\n   <td style=\"text-align:left;\"> weekend </td>\n   <td style=\"text-align:left;\"> 2015-05-31 </td>\n   <td style=\"text-align:right;\"> 2015 </td>\n   <td style=\"text-align:left;\"> May </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nWe also need to load the CSV with the longitude and latitude for the Healthy Ride stations\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_station_locations <- read_csv(\"https://raw.githubusercontent.com/conorotompkins/healthy_ride/master/data/stations/station_locations.csv\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_station_totals <- data_long %>% \n  group_by(station_name) %>% \n  summarize(number_of_trips = n()) %>% \n  arrange(desc(number_of_trips), station_name) %>% \n  left_join(data_station_locations) %>% \n  select(station_name, number_of_trips, longitude, latitude)\n\ndf_station_totals %>% \n  head() %>% \n  kable(\"html\") %>% \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\", \"responsive\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> station_name </th>\n   <th style=\"text-align:right;\"> number_of_trips </th>\n   <th style=\"text-align:right;\"> longitude </th>\n   <th style=\"text-align:right;\"> latitude </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Forbes Ave &amp; Market Square </td>\n   <td style=\"text-align:right;\"> 51924 </td>\n   <td style=\"text-align:right;\"> -80.00308 </td>\n   <td style=\"text-align:right;\"> 40.44088 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:right;\"> 47700 </td>\n   <td style=\"text-align:right;\"> -79.98354 </td>\n   <td style=\"text-align:right;\"> 40.45212 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:right;\"> 47700 </td>\n   <td style=\"text-align:right;\"> -79.98322 </td>\n   <td style=\"text-align:right;\"> 40.45174 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Liberty Ave &amp; Stanwix St </td>\n   <td style=\"text-align:right;\"> 45692 </td>\n   <td style=\"text-align:right;\"> -80.00468 </td>\n   <td style=\"text-align:right;\"> 40.44133 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 10th St &amp; Penn Ave (David L. Lawrence Convention Center) </td>\n   <td style=\"text-align:right;\"> 42868 </td>\n   <td style=\"text-align:right;\"> -79.99580 </td>\n   <td style=\"text-align:right;\"> 40.44467 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> S 27th St &amp; Sidney St. (Southside Works) </td>\n   <td style=\"text-align:right;\"> 37356 </td>\n   <td style=\"text-align:right;\"> -79.96611 </td>\n   <td style=\"text-align:right;\"> 40.42790 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nWhere are the Healthy Ride Stations?\n\n\n::: {.cell}\n\n```{.r .cell-code}\npgh_map <- get_map(c(lon = -79.973859, lat = 40.447095), zoom = 13)\npgh_map <- ggmap(pgh_map)\n\npgh_map +\n  geom_point(data = df_station_totals, aes(longitude, latitude, size = number_of_trips),\n             alpha = .75) +\n  scale_size_continuous(\"Number of trips\", range = c(.1, 5)) +\n  theme_minimal() +\n  theme(axis.text = element_blank(),\n        axis.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/_first_map-1.png){width=672}\n:::\n:::\n\n\n\nNext, join the two dataframes:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_long <- data_long %>% \n  select(station_name, station_name_type) %>% \n  group_by(station_name, station_name_type) %>% \n  summarize(number_of_trips = n()) %>% \n  arrange(desc(number_of_trips)) %>% \n  left_join(data_station_locations) %>% \n  ungroup()\n\ndf_long %>% \n  head() %>% \n  kable(\"html\") %>% \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\", \"responsive\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> station_name </th>\n   <th style=\"text-align:left;\"> station_name_type </th>\n   <th style=\"text-align:right;\"> number_of_trips </th>\n   <th style=\"text-align:right;\"> station_number </th>\n   <th style=\"text-align:right;\"> number_of_racks </th>\n   <th style=\"text-align:right;\"> latitude </th>\n   <th style=\"text-align:right;\"> longitude </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Forbes Ave &amp; Market Square </td>\n   <td style=\"text-align:left;\"> to_station_name </td>\n   <td style=\"text-align:right;\"> 29040 </td>\n   <td style=\"text-align:right;\"> 1001 </td>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:right;\"> 40.44088 </td>\n   <td style=\"text-align:right;\"> -80.00308 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:left;\"> to_station_name </td>\n   <td style=\"text-align:right;\"> 25748 </td>\n   <td style=\"text-align:right;\"> 1017 </td>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:right;\"> 40.45212 </td>\n   <td style=\"text-align:right;\"> -79.98354 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:left;\"> to_station_name </td>\n   <td style=\"text-align:right;\"> 25748 </td>\n   <td style=\"text-align:right;\"> 1017 </td>\n   <td style=\"text-align:right;\"> 18 </td>\n   <td style=\"text-align:right;\"> 40.45174 </td>\n   <td style=\"text-align:right;\"> -79.98322 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Liberty Ave &amp; Stanwix St </td>\n   <td style=\"text-align:left;\"> to_station_name </td>\n   <td style=\"text-align:right;\"> 25380 </td>\n   <td style=\"text-align:right;\"> 1000 </td>\n   <td style=\"text-align:right;\"> 16 </td>\n   <td style=\"text-align:right;\"> 40.44133 </td>\n   <td style=\"text-align:right;\"> -80.00468 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Forbes Ave &amp; Market Square </td>\n   <td style=\"text-align:left;\"> from_station_name </td>\n   <td style=\"text-align:right;\"> 22884 </td>\n   <td style=\"text-align:right;\"> 1001 </td>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:right;\"> 40.44088 </td>\n   <td style=\"text-align:right;\"> -80.00308 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 10th St &amp; Penn Ave (David L. Lawrence Convention Center) </td>\n   <td style=\"text-align:left;\"> to_station_name </td>\n   <td style=\"text-align:right;\"> 22040 </td>\n   <td style=\"text-align:right;\"> 1010 </td>\n   <td style=\"text-align:right;\"> 15 </td>\n   <td style=\"text-align:right;\"> 40.44467 </td>\n   <td style=\"text-align:right;\"> -79.99580 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nDo some stations function more as starting points or ending points for trips?\n\n\n::: {.cell}\n\n```{.r .cell-code}\npgh_map +\n  geom_point(data = df_long, aes(longitude, latitude, size = number_of_trips, color = station_name_type),\n             alpha = .75) +\n  scale_size_continuous(\"Number of trips\",range = c(.1, 5)) +\n  scale_color_discrete(\"Station type\") +\n  facet_wrap(~station_name_type) +\n  theme_minimal() +\n  theme(axis.text = element_blank(),\n        axis.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/from_to_map-1.png){width=672}\n:::\n:::\n\n\n\nNo differences are discernible in this view.\n\nA scatter plot shows the differences more effectively:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_from_to <- df_long %>%\n  spread(station_name_type, number_of_trips) %>% \n  rename(from_trips = from_station_name,\n         to_trips = to_station_name) %>% \n  select(station_name, from_trips, to_trips) %>% \n  mutate(differential = abs(from_trips - to_trips))\n\ndf_from_to %>% \n  ggplot(aes(from_trips, to_trips)) +\n  geom_point(size = 1) +\n  gghighlight(label_key = station_name, \n              differential > 4000) +\n  scale_x_continuous(limits = c(0, 30000)) +\n  scale_y_continuous(limits = c(0, 30000)) +\n  coord_equal() +\n  geom_abline() +\n  labs(x = \"From trips\",\n       y = \"To trips\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/scatter_plot-1.png){width=672}\n:::\n:::\n\n\n\nWhat are the top 10 stations in terms of absolute difference between departures and arrivals?\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_from_to %>% \n  ungroup() %>% \n  arrange(desc(differential)) %>% \n  top_n(10, differential) %>% \n  kable(\"html\") %>% \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\", \"responsive\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> station_name </th>\n   <th style=\"text-align:right;\"> from_trips </th>\n   <th style=\"text-align:right;\"> to_trips </th>\n   <th style=\"text-align:right;\"> differential </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Forbes Ave &amp; Market Square </td>\n   <td style=\"text-align:right;\"> 22884 </td>\n   <td style=\"text-align:right;\"> 29040 </td>\n   <td style=\"text-align:right;\"> 6156 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> S 27th St &amp; Sidney St. (Southside Works) </td>\n   <td style=\"text-align:right;\"> 15804 </td>\n   <td style=\"text-align:right;\"> 21552 </td>\n   <td style=\"text-align:right;\"> 5748 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Liberty Ave &amp; Stanwix St </td>\n   <td style=\"text-align:right;\"> 20312 </td>\n   <td style=\"text-align:right;\"> 25380 </td>\n   <td style=\"text-align:right;\"> 5068 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 42nd St &amp; Butler St </td>\n   <td style=\"text-align:right;\"> 11152 </td>\n   <td style=\"text-align:right;\"> 15580 </td>\n   <td style=\"text-align:right;\"> 4428 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 42nd St &amp; Butler St </td>\n   <td style=\"text-align:right;\"> 11152 </td>\n   <td style=\"text-align:right;\"> 15580 </td>\n   <td style=\"text-align:right;\"> 4428 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 42nd &amp; Penn Ave. </td>\n   <td style=\"text-align:right;\"> 9184 </td>\n   <td style=\"text-align:right;\"> 4760 </td>\n   <td style=\"text-align:right;\"> 4424 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Taylor St &amp; Liberty Ave </td>\n   <td style=\"text-align:right;\"> 8948 </td>\n   <td style=\"text-align:right;\"> 5072 </td>\n   <td style=\"text-align:right;\"> 3876 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:right;\"> 21952 </td>\n   <td style=\"text-align:right;\"> 25748 </td>\n   <td style=\"text-align:right;\"> 3796 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:right;\"> 21952 </td>\n   <td style=\"text-align:right;\"> 25748 </td>\n   <td style=\"text-align:right;\"> 3796 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Penn Ave &amp; N Fairmount St </td>\n   <td style=\"text-align:right;\"> 6604 </td>\n   <td style=\"text-align:right;\"> 2816 </td>\n   <td style=\"text-align:right;\"> 3788 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nLet's map the connections between stations by drawing lines between the stations.\n\nFirst, widen the data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_wide <- data_long %>%\n  spread(station_name_type, station_name) %>% \n  select(from_station_name, to_station_name) %>% \n  left_join(data_station_locations, by = c(\"from_station_name\" = \"station_name\")) %>%\n  rename(from_latitude = latitude,\n         from_longitude = longitude) %>% \n  left_join(data_station_locations, by = c(\"to_station_name\" = \"station_name\")) %>% \n  rename(to_latitude = latitude,\n         to_longitude = longitude) %>% \n  group_by(from_station_name, to_station_name, from_longitude, from_latitude, to_longitude, to_latitude) %>% \n  summarise(number_of_trips = n()) %>% \n  arrange(desc(number_of_trips)) %>% \n  mutate(from_station_type = ifelse(from_station_name == to_station_name,\n                               \"Same station\", \"Different station\"))\n\ndf_wide %>% \n  head() %>% \n  kable(\"html\") %>% \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\", \"condensed\", \"responsive\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> from_station_name </th>\n   <th style=\"text-align:left;\"> to_station_name </th>\n   <th style=\"text-align:right;\"> from_longitude </th>\n   <th style=\"text-align:right;\"> from_latitude </th>\n   <th style=\"text-align:right;\"> to_longitude </th>\n   <th style=\"text-align:right;\"> to_latitude </th>\n   <th style=\"text-align:right;\"> number_of_trips </th>\n   <th style=\"text-align:left;\"> from_station_type </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 10th St &amp; Penn Ave (David L. Lawrence Convention Center) </td>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:right;\"> -79.99580 </td>\n   <td style=\"text-align:right;\"> 40.44467 </td>\n   <td style=\"text-align:right;\"> -79.98354 </td>\n   <td style=\"text-align:right;\"> 40.45212 </td>\n   <td style=\"text-align:right;\"> 4432 </td>\n   <td style=\"text-align:left;\"> Different station </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 10th St &amp; Penn Ave (David L. Lawrence Convention Center) </td>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:right;\"> -79.99580 </td>\n   <td style=\"text-align:right;\"> 40.44467 </td>\n   <td style=\"text-align:right;\"> -79.98322 </td>\n   <td style=\"text-align:right;\"> 40.45174 </td>\n   <td style=\"text-align:right;\"> 4432 </td>\n   <td style=\"text-align:left;\"> Different station </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Boulevard of the Allies &amp; Parkview Ave </td>\n   <td style=\"text-align:left;\"> Fifth Ave &amp; S Bouquet St </td>\n   <td style=\"text-align:right;\"> -79.95188 </td>\n   <td style=\"text-align:right;\"> 40.43434 </td>\n   <td style=\"text-align:right;\"> -79.95760 </td>\n   <td style=\"text-align:right;\"> 40.44232 </td>\n   <td style=\"text-align:right;\"> 3888 </td>\n   <td style=\"text-align:left;\"> Different station </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:left;\"> 10th St &amp; Penn Ave (David L. Lawrence Convention Center) </td>\n   <td style=\"text-align:right;\"> -79.98354 </td>\n   <td style=\"text-align:right;\"> 40.45212 </td>\n   <td style=\"text-align:right;\"> -79.99580 </td>\n   <td style=\"text-align:right;\"> 40.44467 </td>\n   <td style=\"text-align:right;\"> 3640 </td>\n   <td style=\"text-align:left;\"> Different station </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 21st St &amp; Penn Ave </td>\n   <td style=\"text-align:left;\"> 10th St &amp; Penn Ave (David L. Lawrence Convention Center) </td>\n   <td style=\"text-align:right;\"> -79.98322 </td>\n   <td style=\"text-align:right;\"> 40.45174 </td>\n   <td style=\"text-align:right;\"> -79.99580 </td>\n   <td style=\"text-align:right;\"> 40.44467 </td>\n   <td style=\"text-align:right;\"> 3640 </td>\n   <td style=\"text-align:left;\"> Different station </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Fifth Ave &amp; S Bouquet St </td>\n   <td style=\"text-align:left;\"> Boulevard of the Allies &amp; Parkview Ave </td>\n   <td style=\"text-align:right;\"> -79.95760 </td>\n   <td style=\"text-align:right;\"> 40.44232 </td>\n   <td style=\"text-align:right;\"> -79.95188 </td>\n   <td style=\"text-align:right;\"> 40.43434 </td>\n   <td style=\"text-align:right;\"> 3560 </td>\n   <td style=\"text-align:left;\"> Different station </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nThen, layer the data over the map:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npgh_map +\n  geom_segment(data = df_wide, aes(x = from_longitude, xend = to_longitude, \n                                   y = from_latitude, yend = to_latitude, \n                                   alpha = number_of_trips)) +\n  geom_point(data = df_wide, aes(from_longitude, from_latitude), shape = 21, size = 3, fill = \"white\") +\n  geom_point(data = df_wide, aes(to_longitude, to_latitude), shape = 21, size = 3, fill = \"white\") +\n  scale_alpha_continuous(\"Number of trips\", range = c(.0001, 1)) +\n  theme_minimal() +\n  theme(axis.text = element_blank(),\n        axis.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/to_from_map-1.png){width=672}\n:::\n:::\n\n\n\nWe can also facet by the from_station_name variable to see where trips originating from certain stations end at. This plot shows the top 6 stations in terms of trips that began from that station:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_from_stations <- df_wide %>% \n  group_by(from_station_name) %>% \n  summarize(number_of_trips = sum(number_of_trips)) %>% \n  arrange(desc(number_of_trips)) %>% \n  top_n(6) %>% \n  select(from_station_name) %>% \n  unlist()\n\ndf_wide_specific_station <- df_wide %>% \n  filter(from_station_name %in% top_from_stations)\n\npgh_map +\n  geom_segment(data = df_wide_specific_station, aes(x = from_longitude, xend = to_longitude, \n                                   y = from_latitude, yend = to_latitude, \n                                   alpha = number_of_trips), arrow = arrow(length = unit(0.03, \"npc\"))) +\n  geom_point(data = df_wide_specific_station, aes(from_longitude, from_latitude), \n             shape = 1, size = 2) +\n  geom_point(data = df_wide_specific_station, aes(to_longitude, to_latitude), \n             shape = 1, size = 2) +\n  scale_alpha_continuous(\"Number of trips\", range = c(.1, 1)) +\n  facet_wrap(~from_station_name,\n             nrow = 2) +\n  theme_minimal() +\n  theme(axis.text = element_blank(),\n        axis.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/top_from_stations_map-1.png){width=672}\n:::\n:::\n\n\n\nWe can use the same method to examine the top stations in terms of absolute difference between departing and arriving rides:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_diff_stations <- df_from_to %>% \n  arrange(desc(differential)) %>% \n  distinct() %>% \n  top_n(10) %>% \n  select(station_name) %>% \n  unlist()\n  \ndf_wide_diff_station <- df_wide %>% \n  filter(from_station_name %in% top_diff_stations)\n\npgh_map +\n  geom_point(data = df_wide_diff_station, aes(from_longitude, from_latitude), \n             shape = 1, size = 2) +\n  geom_point(data = df_wide_diff_station, aes(to_longitude, to_latitude), \n             shape = 1, size = 2) +\n  geom_segment(data = df_wide_diff_station, aes(x = from_longitude, xend = to_longitude, \n                                   y = from_latitude, yend = to_latitude, \n                                   alpha = number_of_trips),\n               arrow = arrow(length = unit(0.03, \"npc\"))) +\n  scale_alpha_continuous(\"Number of trips\", range = c(.1, 1)) +\n  facet_wrap(~from_station_name,\n             nrow = 2) +\n  theme_minimal() +\n  theme(axis.text = element_blank(),\n        axis.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/top_diff_stations_map-1.png){width=672}\n:::\n:::\n\n\n\nThere does not appear to be a stark difference in the way the network behaves on weekdays vs. weekends:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_wide_day <- data_long %>% \n  spread(station_name_type, station_name) %>% \n  select(from_station_name, to_station_name, is_weekday) %>% \n  left_join(data_station_locations, by = c(\"from_station_name\" = \"station_name\")) %>%\n  rename(from_latitude = latitude,\n         from_longitude = longitude) %>% \n  left_join(data_station_locations, by = c(\"to_station_name\" = \"station_name\")) %>% \n  rename(to_latitude = latitude,\n         to_longitude = longitude) %>% \n  group_by(is_weekday, from_station_name, to_station_name, from_longitude, from_latitude, to_longitude, to_latitude) %>% \n  summarise(number_of_trips = n()) %>% \n  arrange(desc(number_of_trips))\n\npgh_map +\n  geom_segment(data = df_wide_day, aes(x = from_longitude, xend = to_longitude, \n                                   y = from_latitude, yend = to_latitude, \n                                   alpha = number_of_trips)) +\n  geom_point(data = df_wide_day, aes(from_longitude, from_latitude), shape = 21, size = 3, fill = \"white\") +\n  geom_point(data = df_wide_day, aes(to_longitude, to_latitude), shape = 21, size = 3, fill = \"white\") +\n  scale_alpha_continuous(\"Number of trips\", range = c(.05, .3)) +\n  facet_wrap(~is_weekday) +\n  theme_minimal() +\n  theme(axis.text = element_blank(),\n        axis.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/to_from_wday_map-1.png){width=672}\n:::\n:::\n\n\n\nThere are clear differences in the number of rides across different times of day, but the geographic pattern of departures and arrivals does not appear to change:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_wide_tod <- data_long %>% \n  spread(station_name_type, station_name) %>% \n  select(from_station_name, to_station_name, hour) %>% \n  mutate(time_of_day = cut(hour, breaks = c(-Inf, 3, 6, 9, 12, 15, 18, 21, Inf), \n                           labels = c(\"0-3\", \"3-6\", \"6-9\", \"9-12\", \"12-15\", \"15-18\", \"18-21\", \"21-24\"), \n                           ordered_result = TRUE)) %>% \n  left_join(data_station_locations, by = c(\"from_station_name\" = \"station_name\")) %>%\n  rename(from_latitude = latitude,\n         from_longitude = longitude) %>% \n  left_join(data_station_locations, by = c(\"to_station_name\" = \"station_name\")) %>% \n  rename(to_latitude = latitude,\n         to_longitude = longitude) %>% \n  group_by(time_of_day, from_station_name, to_station_name, \n           from_longitude, from_latitude, \n           to_longitude, to_latitude) %>% \n  summarise(number_of_trips = n()) %>% \n  arrange(desc(number_of_trips))\n\npgh_map +\n  geom_segment(data = df_wide_tod, aes(x = from_longitude, xend = to_longitude, \n                                   y = from_latitude, yend = to_latitude, \n                                   alpha = number_of_trips)) +\n  geom_point(data = df_wide_tod, aes(from_longitude, from_latitude), shape = 21, size = 2, fill = \"white\") +\n  geom_point(data = df_wide_tod, aes(to_longitude, to_latitude), shape = 21, size = 2, fill = \"white\") +\n  scale_alpha_continuous(\"Number of trips\", range = c(.05, .3)) +\n  facet_wrap(~time_of_day) +\n  labs(title = \"Time of day\") +\n  theme_minimal() +\n  theme(axis.text = element_blank(),\n        axis.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/to_from_tod_map-1.png){width=672}\n:::\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}