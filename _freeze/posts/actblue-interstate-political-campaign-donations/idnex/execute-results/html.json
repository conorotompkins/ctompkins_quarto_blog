{
  "hash": "1cb929f8551abb6ce61e2520e4eab316",
  "result": {
    "engine": "knitr",
    "markdown": "---\n# Documentation: https://sourcethemes.com/academic/docs/managing-content/\n\ntitle: \"Actblue Interstate Political Campaign Donations\"\nsubtitle: \"\"\nsummary: \"\"\nauthors: [Conor Tompkins]\ntags: [R, Politics]\ncategories: [R, Politics]\ndate: 2018-11-11\nlastmod: 2020-09-03\nfeatured: false\ndraft: false\nimage: featured.png\nprojects: []\neditor_options: \n  chunk_output_type: console\nexecute:\n  echo: true\n  warning: false\n  message: false\n---\n\nActBlue is an online service that allows people to make donations to the political campaigns of Democractic candidates across the country. This post uses graph theory to analyze how political donations moved across states.\n\n## Setup\n\nThese are the libraries and graph theme I will use:\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(maps)\nlibrary(sf)\n#library(rgeos)\nlibrary(janitor)\nlibrary(ggrepel)\nlibrary(tidygraph)\nlibrary(ggraph)\n\ntheme_set(theme_graph())\n\nsf::sf_use_s2(FALSE)\n```\n:::\n\n\nThis code pulls the boundary polygons for the 48 continental U.S. states and the District of Columbia.\n\n::: {.cell}\n\n```{.r .cell-code}\n#states <- st_as_sf(map(\"state\", plot = FALSE, fill = TRUE))\nstates <- st_as_sf(maps::map(\"state\", fill=TRUE, plot =FALSE))\nhead(states)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -124.3834 ymin: 30.24071 xmax: -71.78015 ymax: 42.04937\nGeodetic CRS:  +proj=longlat +ellps=clrk66 +no_defs +type=crs\n                     ID                           geom\nalabama         alabama MULTIPOLYGON (((-87.46201 3...\narizona         arizona MULTIPOLYGON (((-114.6374 3...\narkansas       arkansas MULTIPOLYGON (((-94.05103 3...\ncalifornia   california MULTIPOLYGON (((-120.006 42...\ncolorado       colorado MULTIPOLYGON (((-102.0552 4...\nconnecticut connecticut MULTIPOLYGON (((-73.49902 4...\n```\n\n\n:::\n:::\n\n\nThis code finds the center of each state, which will act as the nodes for the network graph.\n\n::: {.cell}\n\n```{.r .cell-code}\nstates <- cbind(states, st_coordinates(st_centroid(states)))\n```\n:::\n\n\nI used [this website](https://www.infoplease.com/state-abbreviations-and-state-postal-codes) to get the abbreviations for each state.\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_abbreviations <- read_csv(\"https://raw.githubusercontent.com/conorotompkins/politics/master/data/state_abbreviations.csv\") %>% \n  clean_names() %>% \n  mutate(state_district = tolower(state_district)) %>% \n  rename(abbr = postal_code) %>% \n  select(-abbreviation)\n\nstates <- states %>% \n  left_join(state_abbreviations, by = c(\"ID\" = \"state_district\")) %>% \n  arrange(abbr)\n```\n:::\n\n\nThis pulls the ActBlue data from the [Center of Public Integrity GitHub repo](https://www.publicintegrity.org/).\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- read_csv(\"https://raw.githubusercontent.com/PublicI/actblue-analysis/master/data/actblue_states.csv\")\n```\n:::\n\n\nThis joins the boundary data with the state abbreviations.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  semi_join(states, by = c(\"contributor_state\" = \"abbr\")) %>% \n  semi_join(states, by = c(\"recipient_state\" = \"abbr\")) -> df\n\ndf %>% \n  select(-c(1, count, sum)) %>% \n  gather(state_type, state_name) %>% \n  distinct() %>% \n  group_by(state_type) %>% \n  summarize(n = n())\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 Ã— 2\n  state_type            n\n  <chr>             <int>\n1 contributor_state    49\n2 recipient_state      49\n```\n\n\n:::\n:::\n\n\nThis code joins the boundary data with the ActBlue data and excludes donations to and from non-continental U.S. states/territories.\n\n::: {.cell}\n\n```{.r .cell-code}\nstates %>% \n  semi_join(df, by = c(\"abbr\" = \"contributor_state\")) %>% \n  semi_join(df, by = c(\"abbr\" = \"recipient_state\"))  -> states\n```\n:::\n\n\nThis plot shows that the boundary shapes and centroids are correct.\n\n::: {.cell}\n\n```{.r .cell-code}\nstates %>% \n  ggplot() +\n  geom_sf() +\n  geom_point(aes(X, Y)) +\n  theme(panel.grid.major = element_line(colour = 'transparent'))\n```\n\n::: {.cell-output-display}\n![](idnex_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nThis code cleans up the ActBlue data and removes intrastate donations.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>%\n  select(-1) %>% \n  arrange(contributor_state, recipient_state) %>% \n  mutate(sum = sum / 10^6,\n         sum = round(sum, digits = 2)) %>% \n  na.omit() %>% \n  filter(!(contributor_state == recipient_state)) -> df_intermediate\n```\n:::\n\n\n## First attempt\n\nThis is how the data looks when graphed as a typical network graph. The nodes (states) are not positioned geographically, which makes it difficult to understand. Aggregate donations less than $1,000,000 are excluded.\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_intermediate %>% \n  as_tbl_graph(directed = TRUE) %>% \n  activate(edges) %>% \n  filter(sum >= 1) %>% \n  ggraph(layout =) +\n  geom_node_label(aes(label = name), size = 1, repel = FALSE) +\n  geom_edge_fan(aes(edge_width = sum, edge_alpha = sum),\n                arrow = arrow(length = unit(4, 'mm')), \n                start_cap = circle(3, 'mm'),\n                end_cap = circle(3, 'mm'),\n                color = \"blue\") +\n  scale_edge_width_continuous(\"Donations in millions USD\", range = c(.3, 2)) +\n  scale_edge_alpha_continuous(\"Donations in millions USD\", range = c(.1, 1))\n```\n\n::: {.cell-output-display}\n![](idnex_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## Mapping node positions to state geography\n\nThis code turns the data into a network object and sets the minimum threshhold at $1 million\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_intermediate %>% \n  as_tbl_graph(directed = TRUE) -> g\n\nthreshhold <- 1\n\ng %>% \n  activate(edges) %>% \n  filter(sum >= 1) -> g\n```\n:::\n\n\nThis code creates the node positions for the network graph. The centroid of each state will be used as the node for that state.\n\n::: {.cell}\n\n```{.r .cell-code}\nnode_pos <- states %>%\n  select(abbr, X, Y) %>%\n  rename(x = X, y = Y) %>%  # node positions must be called x, y\n  st_set_geometry(NULL)\nstr(node_pos)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t49 obs. of  3 variables:\n $ abbr: chr  \"AL\" \"AR\" \"AZ\" \"CA\" ...\n $ x   : num  -86.8 -92.4 -111.7 -119.6 -105.6 ...\n $ y   : num  32.8 34.9 34.3 37.3 39 ...\n```\n\n\n:::\n:::\n\n\nThis code creates the node layout the graph will use and merges the network data with the layout.\n\n::: {.cell}\n\n```{.r .cell-code}\nmanual_layout <- create_layout(g, \n                     #'manual',\n                     layout = node_pos)\n```\n:::\n\n\n\n\nThis is the final graph:\n\n::: {.cell}\n\n```{.r .cell-code}\nggraph(manual_layout) +\n  geom_sf(data = states) +\n  geom_node_point(size = .5, alpha = 0) +\n  geom_edge_fan(aes(edge_width = sum, edge_alpha = sum),\n                arrow = arrow(length = unit(4, 'mm')), \n                start_cap = circle(1, 'mm'),\n                end_cap = circle(1, 'mm'),\n                color = \"blue\") +\n  scale_edge_width_continuous(\"Donations in millions USD\", range = c(.3, 2)) +\n  scale_edge_alpha_continuous(\"Donations in millions USD\", range = c(.1, 1)) +\n  labs(title = \"ActBlue Political Donations\",\n       subtitle = str_c(\"Aggregate interstate donations greater than $\", threshhold, \" million USD, 2017-01-01 to 2018-09-30\"),\n       caption = \"@conor_tompkins, data from Center for Public Integrity and 538\") +\n  theme(panel.grid.major = element_line(colour = 'transparent')) -> p\n\np\n```\n\n::: {.cell-output-display}\n![](idnex_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n## To and From\n\nThis shows all the donations from California. Note the different scale of funds.\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggraph(manual_layout) +\n  geom_sf(data = states) +\n  geom_node_point(size = .5, alpha = 0) +\n  geom_edge_fan(aes(edge_width = sum, edge_alpha = sum),\n                arrow = arrow(length = unit(4, 'mm')), \n                start_cap = circle(1, 'mm'),\n                end_cap = circle(1, 'mm'),\n                color = \"blue\") +\n  scale_edge_width_continuous(\"Donations in millions USD\", range = c(.3, 2)) +\n  scale_edge_alpha_continuous(\"Donations in millions USD\", range = c(.1, 1)) +\n  labs(title = \"ActBlue Political Donations\",\n       subtitle = str_c(\"Aggregate interstate donations from \", from_state, \", 2017-01-01 to 2018-09-30\"),\n       caption = \"@conor_tompkins, data from Center for Public Integrity and 538\") +\n  theme(panel.grid.major = element_line(colour = 'transparent')) -> p_ca\n\np_ca\n```\n\n::: {.cell-output-display}\n![](idnex_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\nThis shows the donations to candidates in Texas. Note the different scale of funds.\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# manual_layout <- create_layout(graph = g,\n#                                layout = \"manual\", node.positions = node_pos)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggraph(manual_layout) +\n  geom_sf(data = states) +\n  geom_node_point(size = .5, alpha = 0) +\n  geom_edge_fan(aes(edge_width = sum, edge_alpha = sum),\n                arrow = arrow(length = unit(4, 'mm')), \n                start_cap = circle(1, 'mm'),\n                end_cap = circle(1, 'mm'),\n                color = \"blue\") +\n  scale_edge_width_continuous(\"Donations in millions USD\", range = c(.3, 2)) +\n  scale_edge_alpha_continuous(\"Donations in millions USD\", range = c(.1, 1)) +\n  labs(title = \"ActBlue Political Donations\",\n       subtitle = str_c(\"Aggregate interstate donations to \", to_state, \", 2017-01-01 to 2018-09-30\"),\n       caption = \"@conor_tompkins, data from Center for Public Integrity and 538\") +\n  theme(panel.grid.major = element_line(colour = 'transparent')) -> p_tx\n\np_tx\n```\n\n::: {.cell-output-display}\n![](idnex_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n## References\n\n* https://github.com/PublicI/actblue-analysis\n* https://datascience.blog.wzb.eu/2018/05/31/three-ways-of-visualizing-a-graph-on-a-map/\n* https://lookatthhedata.netlify.com/2017-11-12-mapping-your-oyster-card-journeys-in-london-with-tidygraph-and-ggraph/\n",
    "supporting": [
      "idnex_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}