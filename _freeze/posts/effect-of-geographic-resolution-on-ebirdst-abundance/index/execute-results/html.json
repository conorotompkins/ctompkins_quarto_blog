{
  "hash": "a4804d6f6066e1503cfd5ae3a2ec8fe2",
  "result": {
    "markdown": "---\n# Documentation: https://sourcethemes.com/academic/docs/managing-content/\n\ntitle: \"Effect of Geographic Resolution on ebirdst Abundance\"\nsubtitle: \"\"\nsummary: \"\"\nauthor: 'Conor Tompkins'\ntags: [R, eBird]\ncategories: [R, eBird]\ndate: 2021-11-23T08:20:43-05:00\nlastmod: 2021-11-23T08:20:43-05:00\nfeatured: false\ndraft: false\nprojects: []\nfreeze: true\nexecute:\n  echo: true\n  message: false\n  warning: false\n---\n\n\nWhile exploring some of the citizen science bird observation data available through [`ebirdst`](https://cornelllabofornithology.github.io/ebirdst/), I was confused by how to understand the calculation of `ebirdst`'s `abundance` metric.\n\nThe `ebirdst` documentation (`?ebirdst::load_raster`) defines `abundance` as:\n\n> the expected relative abundance, computed as the product of the probability of occurrence and the count conditional on occurrence, of the species on an eBird Traveling Count by a skilled eBirder starting at the optimal time of day with the optimal search duration and distance that maximizes detection of that species in a region.\n\nI had seen some weird results when trying to manually calculate `abundance` as `occurrence * count`. My initial attempt had aggregated the results by month.\n\nThe underlying problem is that `abundance` and `count` are the results of models, and are subject to model error. I also believe that the data outputted from `load_raster` lacks the necessary significant digits to accurately recreate `abundance`. Lowering the resolution or aggregating the data will exacerbate this issue.\n\nThis code loads my [convenience function](https://github.com/conorotompkins/ebird_shiny_app/blob/main/scripts/functions/pull_species_metric.R) to retrieve a metric for a species at a given geographic resolution. This gets `occurrence`, `count`, and `abundance` for the Northern Cardinal at high (3 km), medium (9 km), and low resolutions (27 km). The function also crops the underlying raster data to Pennsylvania.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(here)\nlibrary(hrbrthemes)\nlibrary(patchwork)\n\nsource(\"https://raw.githubusercontent.com/conorotompkins/ebird_shiny_app/main/scripts/functions/get_species_metric.R\")\n\ntheme_set(theme_ipsum())\n\nspecies_table <- crossing(location = \"Pennsylvania\",\n                          species = c(\"Northern Cardinal\"),\n                          metric = c(\"occurrence\", \"count\", \"abundance\"),\n                          resolution = c(\"hr\", \"mr\", \"lr\"))\n\nspecies_table\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 9 × 4\n  location     species           metric     resolution\n  <chr>        <chr>             <chr>      <chr>     \n1 Pennsylvania Northern Cardinal abundance  hr        \n2 Pennsylvania Northern Cardinal abundance  lr        \n3 Pennsylvania Northern Cardinal abundance  mr        \n4 Pennsylvania Northern Cardinal count      hr        \n5 Pennsylvania Northern Cardinal count      lr        \n6 Pennsylvania Northern Cardinal count      mr        \n7 Pennsylvania Northern Cardinal occurrence hr        \n8 Pennsylvania Northern Cardinal occurrence lr        \n9 Pennsylvania Northern Cardinal occurrence mr        \n```\n:::\n:::\n\n::: {.cell hash='index_cache/html/unnamed-chunk-2_e2d2e1f52ee8e829b3481b7c4667370f'}\n\n```{.r .cell-code}\nspecies_metrics <- species_table %>% \n  mutate(data = pmap(list(location, species, metric, resolution), ~get_species_metric(..1, ..2, ..2, ..3, ..4))) %>% \n  mutate(resolution = fct_relevel(resolution, c(\"hr\", \"mr\", \"lr\"))) %>% \n  arrange(species, metric, resolution)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_metrics\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 9 × 5\n  location     species           metric     resolution data            \n  <chr>        <chr>             <chr>      <fct>      <list>          \n1 Pennsylvania Northern Cardinal abundance  hr         <named list [2]>\n2 Pennsylvania Northern Cardinal abundance  mr         <named list [2]>\n3 Pennsylvania Northern Cardinal abundance  lr         <named list [2]>\n4 Pennsylvania Northern Cardinal count      hr         <named list [2]>\n5 Pennsylvania Northern Cardinal count      mr         <named list [2]>\n6 Pennsylvania Northern Cardinal count      lr         <named list [2]>\n7 Pennsylvania Northern Cardinal occurrence hr         <named list [2]>\n8 Pennsylvania Northern Cardinal occurrence mr         <named list [2]>\n9 Pennsylvania Northern Cardinal occurrence lr         <named list [2]>\n```\n:::\n:::\n\n\nThis unnests the data and recalculates abundance (`abundance_test`) and the difference between actual `abundance` and `abundance_test`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_table_unnested <- species_metrics %>%\n  unnest(data) %>% \n  unnest(data) %>%\n  select(species, resolution, date, month, x, y, metric_desc, value) %>% \n  pivot_wider(id_cols = c(species, resolution, date, month, x, y),\n              names_from = metric_desc,\n              values_from = value) %>% \n  select(species, resolution, date, month, x, y, count, occurrence, abundance) %>% \n  mutate(abundance_test = count * occurrence,\n         diff = abundance - abundance_test)\n```\n:::\n\n\nGrouping by month to get to the county level changes the grain of the data so much that `abundance_test` undershoots `abundance` by 20%. This occurs at all resolutions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_metrics %>%\n  unnest(data) %>% \n  unnest(data) %>%\n  select(species, resolution, date, month, x, y, metric_desc, value) %>% \n  pivot_wider(id_cols = c(species, resolution, date, month, x, y),\n              names_from = metric_desc,\n              values_from = value) %>% \n  select(species, resolution, date, month, x, y, count, occurrence, abundance) %>% \n  group_by(species, month, resolution) %>% \n  summarize(occurrence = mean(occurrence, na.rm = T),\n            count = mean(count, na.rm = T),\n            abundance = mean(abundance, na.rm = T)) %>% \n  ungroup() %>% \n  mutate(abundance_test = count * occurrence,\n         diff = abundance - abundance_test) %>% \n  ggplot(aes(abundance, abundance_test)) +\n  geom_abline() +\n  geom_point() +\n  facet_wrap(~resolution) +\n  tune::coord_obs_pred()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nTotally un-aggregated, `abundance_test` closely resembles `abundance`, but degrades as resolution decreases.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_table_unnested %>% \n  select(abundance, abundance_test, resolution) %>% \n  drop_na() %>% \n  ggplot(aes(abundance, abundance_test)) +\n  geom_density_2d_filled(contour_var = \"ndensity\") +\n  geom_abline(color = \"white\") +\n  facet_wrap(~resolution) +\n  tune::coord_obs_pred() +\n  coord_cartesian(xlim = c(0, 4),\n                  ylim = c(0, 4)) +\n  guides(fill = guide_colorsteps())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nAt lower resolutions, the difference is positively skewed, which means that `abundance` is higher than `abundance_test.`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_table_unnested %>% \n  drop_na(diff) %>% \n  ggplot(aes(diff)) +\n  geom_histogram() +\n  facet_wrap(~resolution, scale = \"free_y\", ncol = 1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nAt the highest resolution, `diff` is heteroskedastic. At lower resolutions, there are patterns to the error.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_table_unnested %>% \n  drop_na(occurrence, diff) %>% \n  ggplot(aes(occurrence, diff)) +\n  geom_density_2d_filled(contour_var = \"ndensity\") +\n  facet_wrap(~resolution) + \n  scale_x_percent() +\n  guides(fill = guide_colorsteps())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nThis was a useful exercise for me to understand how the geographic resolution and other aggregation of the data can affect estimated metrics, specifically in the citizen science context.\n\n## Update\n\nI made an issue on the [ebirdst](https://github.com/CornellLabofOrnithology/ebirdst/issues/33) Github page and talked to one of the maintainers about their definitions of count and abundance. I now have a much stronger understanding of these variables.\n\nThe following code reproduces the graph I attached to the issue:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-9_288942a2b00b18cd5cf13452866d3275'}\n\n```{.r .cell-code}\nlibrary(hrbrthemes)\ntheme_set(theme_ipsum())\n\nnorcar_table <- crossing(location = \"Pennsylvania\",\n                         species = c(\"Northern Cardinal\"),\n                          metric = c(\"occurrence\", \"count\", \"abundance\"),\n                          resolution = c(\"hr\"))\n\nnorcar_metrics <- norcar_table %>% \nmutate(data = pmap(list(location, species, metric, resolution), ~get_species_metric(..1, ..2, ..2, ..3, ..4))) %>% \n  mutate(resolution = fct_relevel(resolution, c(\"hr\", \"mr\", \"lr\"))) %>% \n  arrange(species, metric, resolution)\n\nnorcar_metrics_unnested <- norcar_metrics %>%\n  unnest(data) |> \n  unnest(data)\n\nnorcar_metrics_wide <- norcar_metrics_unnested %>% \n  select(species, date, x, y, metric_desc, value) %>% \n  pivot_wider(names_from = metric_desc,\n              values_from = value)\n\nplot_1 <- norcar_metrics_wide %>% \n  drop_na(occurrence, count) %>% \n  ggplot(aes(occurrence, count)) +\n  geom_density_2d_filled(contour_var = \"ndensity\") +\n  scale_x_percent() +\n  guides(fill = \"none\") +\n  theme_bw()\n\nplot_2 <- norcar_metrics_wide %>% \n  drop_na() %>% \n  ggplot(aes(occurrence, abundance)) +\n  geom_density_2d_filled(contour_var = \"ndensity\") +\n  scale_x_percent() +\n  guides(fill = \"none\") +\n  theme_bw()\n\nplot_3 <- norcar_metrics_wide %>%\n  drop_na() %>% \n  ggplot(aes(count, abundance)) +\n  geom_density_2d_filled(contour_var = \"ndensity\") +\n  geom_abline() +\n  guides(fill = \"none\") +\n  theme_bw()\n\nlayout <- \"\nAACC\nBBCC\n\"\n\nplot_1 + plot_2 + plot_3 + \n  plot_layout(guides = 'collect', design = layout) +\n  plot_annotation(title = \"Northern Cardinal in Pennsylvania\")\n```\n:::\n\n\n## Citations\n\nFink, D., T. Auer, A. Johnston, M. Strimas-Mackey, O. Robinson, S. Ligocki, W. Hochachka, C. Wood, I. Davies, M. Iliff, L. Seitz. 2020. eBird Status and Trends, Data Version: 2019; Released: 2020 Cornell Lab of Ornithology, Ithaca, New York. https://doi.org/10.2173/ebirdst.2019\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}