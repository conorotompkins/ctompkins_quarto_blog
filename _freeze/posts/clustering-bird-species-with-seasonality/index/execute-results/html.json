{
  "hash": "d2ebd5e78ca7eb69773e0d2360babd47",
  "result": {
    "markdown": "---\ntitle: \"Clustering Bird Species with Seasonality\"\nsubtitle: \"\"\nsummary: \"\"\nauthors: [Conor Tompkins]\ntags: [R]\ncategories: [R]\ndate: 2020-05-03\nlastmod: 2020-08-07T13:47:31-04:00\nfeatured: false\ndraft: false\n# Focal points: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight.\nimage: featured.png\nprojects: []\neditor_options: \n  chunk_output_type: console\nexecute:\n  echo: true\n  warning: false\n  message: false\n---\n\n\nIn this post, I use k-means clustering to identify clusters of bird species based on frequency of observations per month. I use bird sightings in Allegheny County from [eBird](https://ebird.org/data/download).\n\nLoad the relevant libraries:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(janitor)\nlibrary(vroom)\nlibrary(broom)\nlibrary(hrbrthemes)\n\ntheme_set(theme_bw())\n\nset.seed(1234)\n```\n:::\n\n\nLoad and filter the data:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-2_b1865c6169a802d98c8d15a9f831b84b'}\n\n```{.r .cell-code}\ndf <- vroom(\"post_data/ebd_US-PA-003_201001_202003_relFeb-2020.zip\", delim = \"\\t\") %>% \n  clean_names() %>% \n  mutate_at(vars(observer_id, locality, observation_date, time_observations_started, protocol_type), str_replace_na, \"NA\") %>% \n  mutate(observation_count = as.numeric(str_replace(observation_count, \"X\", as.character(NA))),\n         observation_event_id = str_c(observer_id, locality, observation_date, time_observations_started, sep = \"-\"),\n         observation_date = ymd(observation_date)) %>%\n  filter(all_species_reported == 1)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_top_protocols <- df %>% \n  count(protocol_type, sort = TRUE) %>% \n  slice(1:2)\n\ndf <- df %>% \n  semi_join(df_top_protocols) %>% \n  filter(year(observation_date) >= 2016)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  select(common_name, observation_date, observation_count) %>% \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 533,493\nColumns: 3\n$ common_name       <chr> \"American Black Duck\", \"American Black Duck\", \"Ameri…\n$ observation_date  <date> 2016-01-31, 2016-01-24, 2016-01-30, 2016-01-31, 201…\n$ observation_count <dbl> 2, 2, 2, 3, 2, 3, 57, 7, 2, 4, 1, 5, 8, 1, 1, 4, 1, …\n```\n:::\n:::\n\n\nThis graph shows general seasonality in bird observations:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  count(observation_date) %>% \n  ggplot(aes(observation_date, n)) +\n    geom_line() +\n    labs(x = \"Observation date\",\n         y = \"Observation events\") +\n    scale_y_comma()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nThis code chunk calculates the average number of observations by species and month. Then, it interpolates a value of `0` for birds where there were no sightings in a given month:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmonths <- df %>% \n  mutate(observation_month = month(observation_date, label = TRUE)) %>% \n  distinct(observation_month) %>% \n  pull(observation_month)\n\ndf_seasonality <- df %>% \n  mutate(observation_month = month(observation_date, label = TRUE),\n         observation_year = year(observation_date)) %>% \n  group_by(common_name, observation_year, observation_month) %>% \n  summarize(observation_count = sum(observation_count, na.rm = TRUE)) %>% \n  group_by(common_name, observation_month) %>% \n  summarize(observation_count_mean = mean(observation_count) %>% round(1)) %>% \n  ungroup() %>% \n  complete(common_name, observation_month = months) %>% \n  replace_na(list(observation_count_mean = 0)) %>% \n  arrange(common_name, observation_month)\n\nglimpse(df_seasonality)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 3,672\nColumns: 3\n$ common_name            <chr> \"Acadian Flycatcher\", \"Acadian Flycatcher\", \"Ac…\n$ observation_month      <ord> Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oc…\n$ observation_count_mean <dbl> 0.0, 0.0, 0.0, 0.0, 184.8, 98.5, 67.0, 19.0, 22…\n```\n:::\n:::\n\n\nThis transforms the mean monthly observation into log10:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_seasonality <- df_seasonality %>% \n  mutate(observation_count_mean_log10 = log10(observation_count_mean),\n         observation_count_mean_log10 = case_when(is.infinite(observation_count_mean_log10) ~ 0,\n                                                  TRUE ~ observation_count_mean_log10)) %>% \n  select(-observation_count_mean)\n```\n:::\n\n\nThese graphs show that observations generally increase in the spring and fall, but there is wide variation:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_seasonality %>% \n  ggplot(aes(observation_month, observation_count_mean_log10)) +\n    geom_boxplot() +\n    labs(x = \"Observation month\",\n         y = \"Mean observation count (log10)\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nThis tile graph shows the seasonality trends per species. I sort the birds by ascending mean observation count by month. It shows there are birds that appear year-round, some that appear seasonally, and some that only appear sporadically:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvec_common_name <- df_seasonality %>% \n  pivot_wider(names_from = observation_month, values_from = observation_count_mean_log10, names_prefix = \"month_\") %>% \n  clean_names() %>% \n  arrange(month_jan, month_feb, month_mar, month_apr, month_may, month_jun, month_jul, month_aug, month_sep, month_oct, month_nov, month_dec) %>% \n  pull(common_name)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_seasonality %>%\n  mutate(common_name = factor(common_name, levels = vec_common_name)) %>%\n  ggplot(aes(observation_month, common_name, fill = observation_count_mean_log10)) +\n    geom_tile() +\n    scale_fill_viridis_c(\"Mean observation count (log10)\") +\n    scale_x_discrete(expand = c(0,0)) +\n    scale_y_discrete(expand = c(0,0)) +\n    labs(x = \"Observation month\",\n         y = \"Species\") +\n    theme(panel.grid = element_blank(),\n          axis.text.y = element_blank(),\n          axis.ticks.y = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=1152}\n:::\n:::\n\n\nYou can subjectively see clusters of bird types in the above graph. I will use k-means to attempt to find those clusters.\n\nThis code chunk pivots the data wide to prepare it for clustering:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_seasonality_wide <- df_seasonality %>% \n  select(common_name, observation_month, observation_count_mean_log10) %>% \n  pivot_wider(names_from = observation_month, values_from = observation_count_mean_log10, names_prefix = \"month_\") %>% \n  clean_names()\n\nglimpse(df_seasonality_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 306\nColumns: 13\n$ common_name <chr> \"Acadian Flycatcher\", \"Accipiter sp.\", \"Alder Flycatcher\",…\n$ month_jan   <dbl> 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0…\n$ month_feb   <dbl> 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000…\n$ month_mar   <dbl> 0.0000000, 0.1760913, 0.0000000, 0.0000000, 0.0000000, 0.0…\n$ month_apr   <dbl> 0.0000000, 0.3010300, 0.0000000, 0.0000000, 0.0000000, 0.6…\n$ month_may   <dbl> 2.2667020, 0.3010300, 0.1760913, 0.4771213, 0.0000000, 0.0…\n$ month_jun   <dbl> 1.993436, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000…\n$ month_jul   <dbl> 1.8260748, 0.0000000, 0.0000000, 0.4771213, 0.0000000, 0.0…\n$ month_aug   <dbl> 1.2787536, 0.0000000, 0.0000000, 0.3979400, 0.9030900, 0.0…\n$ month_sep   <dbl> 1.3424227, 0.0000000, 0.0000000, 1.0086002, 1.8450980, 0.0…\n$ month_oct   <dbl> 0.0000000, 0.3010300, 0.0000000, 0.0000000, 0.0000000, 0.0…\n$ month_nov   <dbl> 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0…\n$ month_dec   <dbl> 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0…\n```\n:::\n:::\n\n\nThis uses `purrr` to cluster the data with varying numbers of clusters (1 to 9):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkclusts <- tibble(k = 1:9) %>%\n  mutate(\n    kclust = map(k, ~kmeans(df_seasonality_wide %>% select(-common_name), .x)),\n    tidied = map(kclust, tidy),\n    glanced = map(kclust, glance),\n    augmented = map(kclust, augment, df_seasonality_wide %>% select(-common_name))\n  )\n\nkclusts\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 9 × 5\n      k kclust   tidied            glanced          augmented          \n  <int> <list>   <list>            <list>           <list>             \n1     1 <kmeans> <tibble [1 × 15]> <tibble [1 × 4]> <tibble [306 × 13]>\n2     2 <kmeans> <tibble [2 × 15]> <tibble [1 × 4]> <tibble [306 × 13]>\n3     3 <kmeans> <tibble [3 × 15]> <tibble [1 × 4]> <tibble [306 × 13]>\n4     4 <kmeans> <tibble [4 × 15]> <tibble [1 × 4]> <tibble [306 × 13]>\n5     5 <kmeans> <tibble [5 × 15]> <tibble [1 × 4]> <tibble [306 × 13]>\n6     6 <kmeans> <tibble [6 × 15]> <tibble [1 × 4]> <tibble [306 × 13]>\n7     7 <kmeans> <tibble [7 × 15]> <tibble [1 × 4]> <tibble [306 × 13]>\n8     8 <kmeans> <tibble [8 × 15]> <tibble [1 × 4]> <tibble [306 × 13]>\n9     9 <kmeans> <tibble [9 × 15]> <tibble [1 × 4]> <tibble [306 × 13]>\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nclusters <- kclusts %>%\n  unnest(tidied)\n\nassignments <- kclusts %>% \n  unnest(augmented)\n\nclusterings <- kclusts %>%\n  unnest(glanced)\n```\n:::\n\n\nThis scree plot shows that 2 clusters is probably optimal, but 4 could also be useful:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(clusterings, aes(k, tot.withinss)) +\n  geom_line() +\n  geom_vline(xintercept = 2, linetype = 2) +\n  geom_vline(xintercept = 4, linetype = 2) +\n  scale_x_continuous(breaks = seq(1:9)) +\n  labs(x = \"Number of clusters\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\nThis graph shows how the clustering performed by comparing the observation value in January to the value in the other months, for each `k` cluster value 1 through 4:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nassignments %>% \n  select(k, .cluster, contains(\"month_\")) %>% \n  mutate(id = row_number()) %>% \n  pivot_longer(cols = contains(\"month_\"), names_to = \"observation_month\", values_to = \"observation_count_mean_log10\") %>% \n  mutate(month_jan = case_when(observation_month == \"month_jan\" ~ observation_count_mean_log10,\n                               TRUE ~ as.numeric(NA))) %>% \n  group_by(k, .cluster, id) %>% \n  fill(month_jan, .direction = c(\"down\")) %>% \n  ungroup() %>% \n  filter(observation_month != \"month_jan\",\n         k <= 4) %>% \n  mutate(k = str_c(k, \"cluster(s)\", sep = \" \")) %>% \n  ggplot(aes(observation_count_mean_log10, month_jan, color = .cluster)) +\n    geom_point() +\n    facet_grid(k ~ observation_month) +\n    labs(x = \"Observation month\",\n         y = \"January\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=1152}\n:::\n:::\n\n\nSubjectively, I think the optimal number of clusters is 4. It is noiser, but could show more interesting granularity in seasonality.\n\nThis clusters the data using 4 clusters:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_kmeans <- df_seasonality_wide %>% \n  select(-common_name) %>% \n  kmeans(centers = 4)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_clustered <- augment(df_kmeans, df_seasonality_wide) %>% \n  select(common_name, .cluster)\n\ndf_clustered\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 306 × 2\n   common_name                                   .cluster\n   <chr>                                         <fct>   \n 1 Acadian Flycatcher                            4       \n 2 Accipiter sp.                                 3       \n 3 Alder Flycatcher                              3       \n 4 Alder/Willow Flycatcher (Traill's Flycatcher) 3       \n 5 American Avocet                               3       \n 6 American Bittern                              3       \n 7 American Black Duck                           2       \n 8 American Coot                                 2       \n 9 American Crow                                 1       \n10 American Golden-Plover                        3       \n# ℹ 296 more rows\n```\n:::\n:::\n\n\nThis shows the same style of tile graph as shown previously, but facets it by cluster.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvec_common_name_cluster <- df_seasonality %>%\n  left_join(df_clustered) %>% \n  pivot_wider(names_from = observation_month, values_from = observation_count_mean_log10, names_prefix = \"month_\") %>% \n  clean_names() %>% \n  arrange(cluster, month_jan, month_feb, month_mar, month_apr, month_may, month_jun, month_jul, month_aug, month_sep, month_oct, month_nov, month_dec) %>% \n  pull(common_name)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_seasonality_clustered <-  df_seasonality %>%\n  left_join(df_clustered) %>% \n  mutate(common_name = factor(common_name, levels = vec_common_name_cluster))\n\ndf_seasonality_clustered %>% \n  mutate(.cluster = str_c(\"Cluster\", .cluster, sep = \" \")) %>% \n  ggplot(aes(observation_month, common_name, fill = observation_count_mean_log10)) +\n    geom_tile() +\n    facet_wrap(~.cluster, scales = \"free_y\") +\n    scale_fill_viridis_c(\"Mean observation count (log10)\") +\n    scale_x_discrete(expand = c(0,0)) +\n    scale_y_discrete(expand = c(0,0)) +\n    labs(x = \"Observation month\",\n         y = \"Species\") +\n    theme(panel.grid = element_blank(),\n          axis.text.y = element_blank(),\n          axis.ticks.y = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){width=1152}\n:::\n:::\n\n\nCluster 1 shows birds that only appear sporadically. I think these are birds that migrate through Allegheny County, but do not stick around. Cluster 2 shows birds that are generally around all year. Cluster 3 shows birds that are seen mostly during the summer, and cluster 4 contains birds that appear in the winter.\n\nThis shows a sample of each cluster:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_cluster_sample <- df_clustered %>% \n  group_by(.cluster) %>% \n  sample_n(10, replace = FALSE) %>% \n  ungroup()\n\ndf_seasonality_clustered %>%\n  semi_join(df_cluster_sample) %>% \n  mutate(.cluster = str_c(\"Cluster\", .cluster, sep = \" \")) %>% \n  ggplot(aes(observation_month, common_name, fill = observation_count_mean_log10)) +\n    geom_tile() +\n    facet_wrap(~.cluster, scales = \"free_y\") +\n    scale_fill_viridis_c(\"Mean observation count (log10)\") +\n    scale_x_discrete(expand = c(0,0)) +\n    scale_y_discrete(expand = c(0,0)) +\n    labs(x = \"Observation month\",\n         y = NULL) +\n    theme(panel.grid = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=1152}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}