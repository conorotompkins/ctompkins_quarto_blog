{
  "hash": "3f0ad6359dade7909aca6184dac97e3c",
  "result": {
    "engine": "knitr",
    "markdown": "---\n# Documentation: https://sourcethemes.com/academic/docs/managing-content/\n\ntitle: \"Animating Growth of Allegheny County\"\nsubtitle: \"\"\nsummary: \"\"\nauthors: [Conor Tompkins]\ntags: [R, Allegheny County, WPRDC, Housing]\ncategories: [R, Allegheny County, WPRDC, Housing]\ndate: 2019-03-31\nlastmod: 2019-03-31\nfeatured: false\ndraft: false\nimage: featured.png\nprojects: []\nexecute:\n  warning: false\n  message: false\neditor_options: \n  chunk_output_type: console\n---\n\nIn this post I will show how to create animated graphs that illustrate the increase in buildings in Allegheny County.\n\nOne caveat about the data: it only includes parcels that were sold at some point. If the parcel was not sold, it is not included in this data. For example, a structure that was torn down and replaced **but** was not sold is not included. It is also reasonable to assume that the data quality decreases the older the records are. There may be a large amount of missing data.\n\nThe shapefiles for the parcels come from [Pennsylvania Spatial Data Access](http://www.pasda.psu.edu/uci/DataSummary.aspx?dataset=1214).\n\nThe data about the construction dates comes from the [WPRDC's](http://www.wprdc.org/) [Parcels n'at](http://tools.wprdc.org/parcels-n-at/#) dashboard. To get the relevant data, draw a box around entire county, select the \"Year Built\" field in the Property Assessments section, and then download the data. It will take a while to download data for the entire county.\n\nSet up the environment:\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(janitor)\nlibrary(broom)\nlibrary(sf)\nlibrary(scales)\nlibrary(gganimate)\nlibrary(lwgeom)\n\noptions(scipen = 999, digits = 4)\n\ntheme_set(theme_bw())\n\nmy_caption <- \"@conor_tompkins - data from @WPRDC\"\n```\n:::\n\n\nThis reads in data about the land parcel (lot lines):\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- read_csv(\"post_data/parcel_data.csv\", progress = FALSE) %>% \n  clean_names() |> \n  select(parid, yearblt)\n```\n:::\n\n\nThis reads in the parcel geometry\n\n::: {.cell}\n\n```{.r .cell-code}\nfile <- \"post_data/AlleghenyCounty_Parcels202409/AlleghenyCounty_Parcels202409.shp\"\nfile\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"post_data/AlleghenyCounty_Parcels202409/AlleghenyCounty_Parcels202409.shp\"\n```\n\n\n:::\n\n```{.r .cell-code}\nshapefile <- st_read(file)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `AlleghenyCounty_Parcels202409' from data source \n  `/Users/conorotompkins/Documents/github_repos/ctompkins_quarto_blog/posts/animating-growth-of-allegheny-county/post_data/AlleghenyCounty_Parcels202409/AlleghenyCounty_Parcels202409.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 585186 features and 10 fields (with 9 geometries empty)\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 1243000 ymin: 321300 xmax: 1430000 ymax: 497900\nProjected CRS: NAD83 / Pennsylvania South (ftUS)\n```\n\n\n:::\n:::\n\n\nNext we have to clean up the parcel geometry:\n\n::: {.cell}\n\n```{.r .cell-code}\nvalid_check <- shapefile %>% \n  slice(1:nrow(shapefile)) %>% \n  pull(geometry) %>% \n  map(st_is_valid) %>% \n  unlist()\n\nshapefile$validity_check <- valid_check\n\nshapefile <- shapefile %>% \n  filter(validity_check == TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nshapefile <- shapefile %>% \n  st_make_valid() %>% \n  clean_names() %>% \n  mutate(pin = as.character(pin))\n```\n:::\n\n\nThen, join the parcel geometry and parcel data:\n\n::: {.cell}\n\n```{.r .cell-code}\nparcel_data <- shapefile %>% \n  left_join(df, by = join_by(pin == parid))\n```\n:::\n\n\nThis turns the parcel geometry into `(x, y)` coordinates:\n\n::: {.cell}\n\n```{.r .cell-code}\ncentroids <- parcel_data %>% \n  st_centroid() %>% \n  st_coordinates() %>% \n  as_tibble() %>% \n  clean_names()\n```\n:::\n\n\nWe can plot the coordinates to confirm that the locations make sense:\n\n::: {.cell}\n\n```{.r .cell-code}\ncentroids %>% \n  distinct(x, y) %>% \n  ggplot(aes(x, y)) +\n  geom_point(size = .1, alpha = .1) +\n  theme_void() +\n  coord_equal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nThis plot shows that there is one row where `yearblt_asmt` is zero. That doesn't make sense, so we will exclude it later. \n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  ggplot(aes(yearblt)) +\n  geom_density() +\n  geom_rug() +\n  labs(title = \"Structures in Allegheny County\",\n       x = \"Year built\",\n       y = \"Density\",\n       subtitle = my_caption)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nThis combines the `parcel_data` and `centroid` data:\n\n::: {.cell}\n\n```{.r .cell-code}\nparcel_geometry_cleaned <- bind_cols(parcel_data, centroids) %>% \n  select(pin, x, y, yearblt) %>%\n  mutate(yearblt = as.integer(yearblt)) %>% \n  filter(!is.na(yearblt),\n         yearblt > 1000) %>% \n  st_set_geometry(NULL)\n```\n:::\n\n\nThis plots the culmulative sum of structures built:\n\n::: {.cell}\n\n```{.r .cell-code}\nparcel_cumulative <- parcel_geometry_cleaned %>% \n  select(pin, yearblt) %>% \n  arrange(yearblt) %>% \n  count(yearblt) %>% \n  mutate(cumulative_n = cumsum(n)) %>% \n  ggplot(aes(yearblt, cumulative_n)) +\n  geom_line() +\n  geom_point() +\n  scale_y_continuous(label = comma) +\n    labs(title = \"Cumulative sum of structures built in Allegheny County\",\n       x = \"Year Built\",\n       y = \"Cumulative sum\",\n       caption = my_caption) +\n  transition_reveal(yearblt)\n\nparcel_cumulative\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.gif)\n:::\n:::\n\n\nThis creates a graph of the structures built in Allegheny County, colored by the construction year.\n\n::: {.cell}\n\n```{.r .cell-code}\nparcel_geometry_cleaned %>% \n  ggplot(aes(x, y, color = yearblt, group = pin)) +\n  geom_point(alpha = .3, size = .1) +\n  scale_color_viridis_c(\"Year structure was built\") +\n  theme_void() +\n  theme(axis.text = element_blank(),\n        axis.title = element_blank()) +\n  labs(title = \"Allegheny County land parcels\",\n       subtitle = \"Year built: {frame_along}\",\n       caption = \"@conor_tompkins, data from @WPRDC\") +\n  transition_reveal(yearblt)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.gif)\n:::\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}