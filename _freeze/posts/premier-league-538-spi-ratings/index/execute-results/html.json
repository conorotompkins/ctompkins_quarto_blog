{
  "hash": "cc71850852dc5f9055c5ccc92a9334a6",
  "result": {
    "engine": "knitr",
    "markdown": "---\n# Documentation: https://sourcethemes.com/academic/docs/managing-content/\ntitle: \"Premier League 538 SPI Ratings\"\nsubtitle: \"\"\nsummary: \"\"\nauthors: [Conor Tompkins]\ntags: [R, Pittsburgh, \"538\", Soccer]\ncategories: [R, Pittsburgh, \"538\", Soccer]\ndate: 2019-04-07\nlastmod: 2019-04-07\nfeatured: false\ndraft: false\nimage: featured.png\nprojects: []\nexecute:\n  warning: false\n  message: false\neditor_options: \n  chunk_output_type: console\n---\n\n538's [Soccer Power Index (SPI)](https://projects.fivethirtyeight.com/soccer-predictions/) rates the quality of soccer teams from a variety of leagues around the world. In this post I'll use `gganimate` to animate team SPI over the past 3 seasons.\n\nThe SPI data is available on 538's [GitHub repo](https://github.com/fivethirtyeight/data/tree/master/soccer-spi).\n\nSet up the environment:\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(purrr)\nlibrary(gganimate)\nlibrary(ggrepel)\nlibrary(broom)\nlibrary(lubridate)\n\ntheme_set(theme_minimal(base_size = 18))\n```\n:::\n\n\nLoad the data and make the data long, instead of having different columns for home and away results:\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- read_csv(\"https://projects.fivethirtyeight.com/soccer-api/club/spi_matches.csv\")\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_home <- data %>% \n  select(team1, date, league, spi1) %>% \n  rename(team = team1,\n         spi = spi1) %>% \n  mutate(venue = \"home\")\n\ndf_away <- data %>% \n  select(team2, date, league, spi2) %>% \n  rename(team = team2,\n         spi = spi2) %>% \n  mutate(venue = \"away\")\n\ndf_all <- bind_rows(df_home, df_away) %>% \n  filter(date < \"2019-04-07\") %>% \n  arrange(league, team, date) %>% \n  group_by(league, team) %>% \n  mutate(team_game_number = dense_rank(date)) %>% \n  ungroup()\n```\n:::\n\n\nFilter to EPL teams and add a `season` column:\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_epl <- df_all %>% \n  filter(date < Sys.Date(),\n         league == \"Barclays Premier League\")\n\nseason1 <- tibble(date = seq(ymd('2016-08-13'), ymd('2017-05-21'), by='days'),\n                  season = 1)\n\nseason2 <- tibble(date = seq(ymd('2017-08-11'), ymd('2018-05-13'), by='days'),\n                  season = 2)\n\nseason3 <- tibble(date = seq(ymd('2018-08-10'), ymd('2019-04-06'), by='days'),\n                  season = 3)\n\nseasons <- bind_rows(season1, season2, season3)\n\ndf_epl_smooth <- df_epl %>%\n  left_join(seasons)\n```\n:::\n\n\nCalculate the smoothed SPI per team per season using loess:\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_epl_smooth <- df_epl_smooth %>% \n  nest(-c(team, season)) %>% \n  mutate(m = map(data, loess,\n                          formula = spi ~ team_game_number, span = .5),\n         spi_smooth = purrr::map(m, `[[`, \"fitted\"))\n\ndf_epl_smooth <- df_epl_smooth %>% \n  select(-m) %>% \n  unnest()\n\ndf_epl_last <- df_epl %>% \n  group_by(team) %>% \n  summarize(date = last(date),\n            spi = last(spi))\n```\n:::\n\n\nCreate the animation:\n\n::: {.cell}\n\n```{.r .cell-code}\nspi_smooth_gif <- df_epl_smooth %>% \n  ggplot(aes(date, spi_smooth, color = team, group = team)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_segment(aes(xend = ymd(\"2019-04-05\"), yend = spi_smooth), linetype = 2, colour = 'grey') +\n  geom_label(aes(x = ymd(\"2019-04-05\"), label = team),\n             hjust = -.1,\n             vjust = 0) +\n  geom_rect(xmin = ymd(\"2017-05-25\"), xmax = ymd(\"2017-08-12\"),\n            ymin = -Inf, ymax = Inf,\n            fill = \"white\", color = \"white\") +\n  geom_rect(xmin = ymd(\"2018-05-18\"), xmax = ymd(\"2018-08-10\"),\n                ymin = -Inf, ymax = Inf, fill = \"white\", color = \"white\") +\n  guides(color = FALSE) +\n  labs(title = \"Premier League\",\n       subtitle = \"538 Soccer Power Index\",\n       x = NULL,\n       y = \"538 Soccer Power Index\",\n       caption = \"@conor_tompkins\") +\n  transition_reveal(date) +\n  coord_cartesian(clip = 'off') +\n  theme(plot.margin = margin(5.5, 110, 5.5, 5.5))\n\nanimate(spi_smooth_gif, height = 9, width = 9, duration = 15, nframes = 300)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/spi_smooth_gif-1.gif)\n:::\n:::\n\n\nObservers of the EPL will know that in any given season there are 2-3 tiers of teams, given the economics and relegation structure of the league. In 2018 the difference between the top 6 and the rest of the league was particularly stark. This is partly due to the difficulties that Everton experienced after they sold Lukaku and signed older and less skilled players. This graph highlights Everton's SPI:\n\n::: {.cell}\n\n```{.r .cell-code}\neverton_gif <- df_epl_smooth %>% \n  mutate(everton_flag = case_when(team == \"Everton\" ~ \"Everton\",\n                                  team != \"Everton\" ~ \"\")) %>% \n  ggplot(aes(date, spi_smooth, color = everton_flag, group = team)) +\n  geom_line() +\n  geom_point(size = 2) +\n  geom_segment(aes(xend = ymd(\"2019-04-05\"), yend = spi_smooth), linetype = 2, colour = 'grey') +\n  geom_label(aes(x = ymd(\"2019-04-05\"), label = team),\n             hjust = -.1,\n             vjust = 0) +\n  geom_rect(xmin = ymd(\"2017-05-25\"), xmax = ymd(\"2017-08-12\"),\n            ymin = -Inf, ymax = Inf,\n            fill = \"white\", color = \"white\") +\n  geom_rect(xmin = ymd(\"2018-05-18\"), xmax = ymd(\"2018-08-10\"),\n                ymin = -Inf, ymax = Inf, fill = \"white\", color = \"white\") +\n  scale_color_manual(values = c(\"light grey\", \"blue\")) +\n  guides(color = FALSE) +\n  labs(title = \"Premier League\",\n       subtitle = \"538 Soccer Power Index\",\n       x = NULL,\n       y = \"538 Soccer Power Index\",\n       caption = \"@conor_tompkins\") +\n  transition_reveal(date) +\n  coord_cartesian(clip = 'off') +\n  theme(plot.margin = margin(5.5, 110, 5.5, 5.5))\n\nanimate(everton_gif, height = 9, width = 9, duration = 15, nframes = 300)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/everton_gif-1.gif)\n:::\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}