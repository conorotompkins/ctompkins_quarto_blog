---
title: "Geospatially clustering Pittsburgh"
author: "Conor Tompkins"
editor_options: 
  chunk_output_type: console
---

```{r}
#https://walker-data.com/posts/census-regions/
#https://geodacenter.github.io/rgeoda/articles/rgeoda_tutorial.html#spatial-clustering


library(tidyverse)
library(sf)
library(tidycensus)
library(rgeoda)
library(rmapshaper)
library(leaflet)
library(janitor)
library(tictoc)
```

```{r}
options(tigris_use_cache = TRUE,
        scipen = 999,
        digits = 4)

set.seed(1234)

census_vars <- load_variables(2020, "pl", cache = TRUE)

#View(census_vars)

racevars <- c(White = "P2_005N", 
              Black = "P2_006N", 
              Asian = "P2_008N", 
              Hispanic = "P2_002N",
              Total = "P1_001N")

#total population: B01003_001
pa_tracts <- get_decennial(
  geography = "county",
  variables = racevars,
  state = c("PA", "OH", "WV", "MD", "NY", "NJ", "VA", "KY", "DC"),
  geometry = TRUE,
  #summary_var = "P2_001N",
  year = 2020,
  sumfile = "pl",
  show_call = TRUE,
  cache_table = TRUE
) |> 
  ms_simplify(keep = .01)

pa_tracts |> 
  filter(variable == "Total") |> 
  ggplot() +
  geom_sf(aes(fill = value), lwd = 0) +
  scale_fill_viridis_c()

pa_tracts |> 
  filter(variable == "Total") |> 
  leaflet() |> 
  addPolygons(weight = 0.1)
```

```{r}
pa_tracts_wide <- pa_tracts |> 
  pivot_wider(names_from = variable, values_from = value)

glimpse(pa_tracts_wide)
```

```{r}
pa_tracts_wide |> 
  write_sf("posts/geospatial-clustering-pittsburgh/post_data/pa_tracts/pa_tracts.shp")
```

```{r}
pa_tracts_wide_geo <- geoda_open("posts/geospatial-clustering-pittsburgh/post_data/pa_tracts/pa_tracts.shp")

#this crashes sometimes. investigate cause. could be caused by tracts that have no neighbors?
w <- rook_weights(pa_tracts_wide)

w
```

```{r}
pa_tracts_wide |> 
  ggplot(aes(Total)) +
  geom_histogram()

cluster_df <- pa_tracts_wide |> 
  select(White:Total) |> 
  st_drop_geometry()

bound_vals <- pa_tracts_wide['Total']

#minimum group population is 10% of total population
min_bound <- pa_tracts_wide |> 
  st_drop_geometry() |> 
  summarize(Total = sum(Total)) |> 
  mutate(min_bound = Total * .1) |> 
  pull(min_bound)

tic()
maxp_clusters <- maxp_greedy(w, cluster_df, bound_vals, min_bound)
maxp_clusters
toc()
```

```{r}
pa_clusters <- pa_tracts_wide |> 
  mutate(cluster = as.character(maxp_clusters$Clusters))

pa_clusters |> 
  st_drop_geometry() |> 
  count(cluster, sort = TRUE)

pa_clusters |> 
  ggplot() +
  geom_sf(aes(fill = cluster)) +
  guides(fill = "none")
```

```{r}
fill_pal <- colorFactor(palette = "Paired", domain = pa_clusters$cluster)

labels <- sprintf(
  "<strong>Tract %s</strong><br/>Cluster: %s<br/>White: %d<br/>Black: %d<br/>Asian: %d<br/>Hispanic: %d<br/>Total: %d",
  pa_clusters$GEOID, pa_clusters$cluster, pa_clusters$White, pa_clusters$Black, pa_clusters$Asian, pa_clusters$Hispanic, pa_clusters$Total
) %>% lapply(htmltools::HTML)

pa_clusters |> 
  leaflet() |> 
  addProviderTiles(providers$CartoDB.Positron) |> 
  addPolygons(fillColor = ~fill_pal(cluster),
              fillOpacity = .5,
              weight = .3,
              #stroke = FALSE,
              label = labels,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"))
```
